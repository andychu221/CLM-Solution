<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsuraManage Pro v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .view { display: none; }
        .view.active { display: block; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .details-table { min-width: 100%; }
        .details-table th, .details-table td { padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left; }
        .lang-link.active { font-weight: bold; text-decoration: underline; }
        
        #policies-view.active, #claims-view.active {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px); 
        }
        .table-header-container {
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: #f9fafb;
        }
        .table-body-container {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
        }
        .table-body-container thead th {
            position: sticky;
            top: 0;
            background-color: #f9fafb;
            z-index: 10;
        }
        #sortableColumns li { cursor: grab; }
        #sortableColumns li:grabbing { cursor: grabbing; }
        .chart-toggle button.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-md flex flex-col flex-shrink-0">
            <div class="p-6 text-2xl font-bold text-gray-800 border-b">
                Insura<span class="text-blue-600">Manage</span>
            </div>
            <nav id="sidebar-nav" class="flex-1 p-4 space-y-2">
                <a href="#" data-target="dashboard-view" class="nav-link flex items-center px-4 py-2 text-gray-700 bg-gray-200 rounded-lg">
                    <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i>
                    <span data-i18n-key="nav_dashboard">Dashboard</span>
                </a>
                <a href="#" data-target="policies-view" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-file-contract w-5 h-5 mr-3"></i>
                    <span data-i18n-key="nav_policies">Policy Management</span>
                </a>
                 <a href="#" data-target="claims-view" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-hand-holding-dollar w-5 h-5 mr-3"></i>
                    <span data-i18n-key="nav_claims">Claims Management</span>
                </a>
                <a href="#" data-target="insurers-view" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-building w-5 h-5 mr-3"></i>
                    <span data-i18n-key="nav_insurers">Insurance Companies</span>
                </a>
                <a href="#" data-target="users-view" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-users-cog w-5 h-5 mr-3"></i>
                    <span data-i18n-key="nav_users">User & Permissions</span>
                </a>
                <a href="#" data-target="logs-view" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-history w-5 h-5 mr-3"></i>
                    <span data-i18n-key="nav_logs">Log Management</span>
                </a>
            </nav>
            <div class="p-4 mt-auto border-t space-y-4">
                <div>
                    <label for="user-switcher" class="block text-sm font-medium text-gray-700 mb-1" data-i18n-key="label_switch_user">Switch User</label>
                    <select id="user-switcher" class="block w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2">
                    </select>
                </div>
                 <div id="currentUserDisplay" class="text-sm"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            <header class="bg-white shadow-sm p-4 flex justify-end items-center z-10">
                <div id="language-switcher" class="text-sm space-x-4">
                    <a href="#" class="lang-link text-gray-600 hover:text-blue-600" data-lang="en">English</a>
                    <a href="#" class="lang-link text-gray-600 hover:text-blue-600" data-lang="zh-TW">繁體中文</a>
                    <a href="#" class="lang-link text-gray-600 hover:text-blue-600" data-lang="ja">日本語</a>
                </div>
            </header>
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view active">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6" data-i18n-key="dashboard_title">Dashboard</h1>
                    
                    <div id="statCardContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6"></div>

                    <div id="regionStatsContainer" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"></div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h3 id="insurerChartTitle" class="font-semibold text-gray-600"></h3>
                                <div id="insurerChartToggle" class="text-xs space-x-1 chart-toggle">
                                    <button data-metric="coverage" class="px-3 py-1 rounded" data-i18n-key="btn_coverage"></button>
                                    <button data-metric="premium" class="px-3 py-1 rounded" data-i18n-key="btn_premium"></button>
                                </div>
                            </div>
                            <div class="relative h-72"><canvas id="insurerChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h3 id="typeChartTitle" class="font-semibold text-gray-600"></h3>
                                <div id="typeChartToggle" class="text-xs space-x-1 chart-toggle">
                                    <button data-metric="coverage" class="px-3 py-1 rounded" data-i18n-key="btn_coverage"></button>
                                    <button data-metric="premium" class="px-3 py-1 rounded" data-i18n-key="btn_premium"></button>
                                </div>
                            </div>
                            <div class="relative h-72"><canvas id="typeChart"></canvas></div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-sm lg:col-span-2">
                            <h3 class="font-semibold mb-4 text-gray-600" data-i18n-key="chart_claims_trend">Claims Time Series Trend</h3>
                            <div class="relative h-80"><canvas id="claimsTrendChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm lg:col-span-2">
                            <h3 class="font-semibold mb-4 text-gray-600" data-i18n-key="chart_policy_by_due_month">Policies by Due Month</h3>
                            <div class="relative h-80"><canvas id="policyByDueMonthChart"></canvas></div>
                        </div>
                    </div>

                    <!-- Approval Workflow -->
                    <div class="grid grid-cols-1 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm lg:col-span-2">
                            <h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n-key="approval_workflow_title">Approval Workflow</h2>
                            <div class="overflow-x-auto max-h-80">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                        <tr>
                                            <th scope="col" class="px-6 py-3" data-i18n-key="table_item_id">Item ID</th>
                                            <th scope="col" class="px-6 py-3" data-i18n-key="table_type">Type</th>
                                            <th scope="col" class="px-6 py-3" data-i18n-key="table_created_by">Created By</th>
                                            <th scope="col" class="px-6 py-3" data-i18n-key="table_created_date">Created Date</th>
                                            <th scope="col" class="px-6 py-3" data-i18n-key="table_actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="approvalItemsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Policies View -->
                <div id="policies-view" class="view">
                    <div class="table-header-container bg-white p-6 rounded-lg shadow-sm">
                        <h1 class="text-3xl font-bold text-gray-800 mb-6" data-i18n-key="policy_management_title">Policy Management</h1>
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                             <div class="flex items-center space-x-2 flex-wrap gap-2">
                                <input id="policySearchInput" type="text" data-i18n-key="placeholder_search_policies" placeholder="Search policies..." class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <select id="policyFilterEntity" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="" data-i18n-key="filter_all_entities">All Entities</option>
                                </select>
                                <select id="policyFilterType" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="" data-i18n-key="filter_all_types">All Types</option>
                                </select>
                                <select id="policyFilterStatus" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="" data-i18n-key="filter_all_statuses">All Statuses</option>
                                </select>
                                <select id="policyFilterInsurer" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="" data-i18n-key="filter_all_insurers">All Insurers</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="policyCustomizeColumnsBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition duration-200 flex items-center text-sm">
                                    <i class="fas fa-columns mr-2"></i><span data-i18n-key="btn_customize_columns"></span>
                                </button>
                                <button id="addPolicyBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 flex items-center text-sm">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span data-i18n-key="btn_new_policy">New Policy</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-body-container">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead id="policyTableHead" class="text-xs text-gray-700 uppercase bg-gray-50"></thead>
                            <tbody id="policyTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Claims View -->
                <div id="claims-view" class="view">
                    <div class="table-header-container bg-white p-6 rounded-lg shadow-sm">
                        <h1 class="text-3xl font-bold text-gray-800 mb-6" data-i18n-key="claims_management_title">Claims Management</h1>
                        <div class="flex justify-between items-center mb-4">
                            <input id="claimSearchInput" type="text" data-i18n-key="placeholder_search_claims" placeholder="Search claims..." class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <div class="flex items-center space-x-2">
                                <button id="claimCustomizeColumnsBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition duration-200 flex items-center text-sm">
                                    <i class="fas fa-columns mr-2"></i><span data-i18n-key="btn_customize_columns"></span>
                                </button>
                                <button id="addClaimBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 flex items-center text-sm">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span data-i18n-key="btn_new_claim">New Claim</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-body-container">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead id="claimsTableHead" class="text-xs text-gray-700 uppercase bg-gray-50"></thead>
                            <tbody id="claimsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Insurers View -->
                <div id="insurers-view" class="view">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6" data-i18n-key="insurer_management_title">Insurer Management</h1>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <input id="insurerSearchInput" type="text" data-i18n-key="placeholder_search_insurers" placeholder="Search insurers..." class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <button id="addInsurerBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 flex items-center text-sm">
                                <i class="fas fa-plus mr-2"></i>
                                <span data-i18n-key="btn_new_insurer">New Insurer</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_insurer_id">Insurer ID</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_insurer_name">Insurer Name</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_region">Region</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="insurerTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Users View -->
                <div id="users-view" class="view">
                     <h1 class="text-3xl font-bold text-gray-800 mb-6" data-i18n-key="user_management_title">User & Permissions Management</h1>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <input id="userSearchInput" type="text" data-i18n-key="placeholder_search_users" placeholder="Search users..." class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_user_id">User ID</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_username">Username</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_role">Role</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_region">Assigned Region</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Logs View -->
                <div id="logs-view" class="view">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6" data-i18n-key="log_management_title">Log Management</h1>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="overflow-x-auto max-h-[75vh]">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_timestamp">Timestamp</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_user">User</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_action_log">Action</th>
                                        <th scope="col" class="px-6 py-3" data-i18n-key="table_details">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="logTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Policy Modal -->
    <div id="addEditPolicyModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-full overflow-y-auto">
            <form id="policyForm" class="w-full">
                <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                    <h3 id="policyModalTitle" class="text-xl font-semibold"></h3>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600">
                       <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <div id="policyFormBody" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- Policy fields will be dynamically loaded here -->
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2 sticky bottom-0">
                    <button type="button" class="close-modal-btn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50" data-i18n-key="btn_cancel">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-blue-700" data-i18n-key="btn_save">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Claim Modal -->
    <div id="addClaimModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto">
            <form id="claimForm" class="w-full">
                <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                    <h3 id="claimModalTitle" class="text-xl font-semibold"></h3>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600">
                       <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <div id="claimFormBody" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- Claim fields will be dynamically loaded here -->
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2 sticky bottom-0">
                    <button type="button" class="close-modal-btn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50" data-i18n-key="btn_cancel">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-blue-700" data-i18n-key="btn_save">Submit Claim</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Policy Detail Modal -->
    <div id="policyDetailModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-full overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-xl font-semibold" data-i18n-key="modal_policy_detail_title">Policy Details</h3>
                <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600">
                   <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="policyDetailBody" class="p-6">
                <!-- Details will be loaded here -->
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2 sticky bottom-0">
                <button type="button" class="close-modal-btn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50" data-i18n-key="btn_close">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Claim Detail Modal -->
    <div id="claimDetailModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-full overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-xl font-semibold" data-i18n-key="modal_claim_detail_title">Claim Details</h3>
                <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600">
                   <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="claimDetailBody" class="p-6">
                <!-- Claim details will be loaded here -->
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2 sticky bottom-0">
                <button type="button" class="close-modal-btn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50" data-i18n-key="btn_close">Close</button>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdfViewerModal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-5/6 flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="pdfViewerTitle" class="text-xl font-semibold">PDF Preview</h3>
                <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600">
                   <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="flex-1 p-4 overflow-hidden">
                <iframe id="pdfViewerFrame" src="" class="w-full h-full border-none"></iframe>
            </div>
        </div>
    </div>

    <!-- Custom Confirm/Message Modal -->
    <div id="customConfirmModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 border-b">
                <h3 id="customConfirmModalTitle" class="text-xl font-semibold">Confirm Action</h3>
            </div>
            <div class="p-6">
                <p id="customConfirmModalMessage" class="text-gray-700"></p>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2">
                <button type="button" id="customConfirmCancelBtn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50" data-i18n-key="btn_cancel">Cancel</button>
                <button type="button" id="customConfirmOKBtn" class="bg-blue-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-blue-700" data-i18n-key="btn_ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Insurer Modal -->
    <div id="addEditInsurerModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-full overflow-y-auto">
            <form id="insurerForm" class="w-full">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="insurerModalTitle" class="text-xl font-semibold" data-i18n-key="modal_add_insurer_title">Add New Insurer</h3>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600">
                       <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="insurer_id_input" class="block text-sm font-medium text-gray-700" data-i18n-key="form_insurer_id">Insurer ID</label>
                        <input type="text" id="insurer_id_input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                    </div>
                    <div>
                        <label for="insurer_name_input" class="block text-sm font-medium text-gray-700" data-i18n-key="form_insurer_name">Insurer Name</label>
                        <input type="text" id="insurer_name_input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                    </div>
                    <div>
                        <label for="insurer_region_input" class="block text-sm font-medium text-gray-700" data-i18n-key="form_region">Region</label>
                        <input type="text" id="insurer_region_input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2">
                    <button type="button" class="close-modal-btn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50" data-i18n-key="btn_cancel">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-blue-700" data-i18n-key="btn_save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="addEditUserModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-full overflow-y-auto">
            <form id="userForm" class="w-full">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="userModalTitle" class="text-xl font-semibold" data-i18n-key="modal_edit_user_title">Edit User</h3>
                    <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600">
                       <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="user_id_input" class="block text-sm font-medium text-gray-700" data-i18n-key="table_user_id">User ID</label>
                        <input type="text" id="user_id_input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="username_input" class="block text-sm font-medium text-gray-700" data-i18n-key="table_username">Username</label>
                        <input type="text" id="username_input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                    </div>
                    <div>
                        <label for="role_input" class="block text-sm font-medium text-gray-700" data-i18n-key="table_role">Role</label>
                        <select id="role_input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                        </select>
                    </div>
                    <div>
                        <label for="assigned_region_input" class="block text-sm font-medium text-gray-700" data-i18n-key="table_region">Assigned Region</label>
                        <input type="text" id="assigned_region_input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2">
                    <button type="button" class="close-modal-btn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50" data-i18n-key="btn_cancel">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-blue-700" data-i18n-key="btn_save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customize Columns Modal -->
    <div id="customizeColumnsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-full overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold" data-i18n-key="modal_customize_columns_title"></h3>
                <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-6">
                <div id="columnCheckboxes" class="grid grid-cols-2 gap-4"></div>
                <div class="mt-6">
                    <h4 class="font-semibold mb-2" data-i18n-key="label_column_order"></h4>
                    <ul id="sortableColumns" class="bg-gray-50 border border-gray-300 rounded-md p-2 space-y-2"></ul>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2">
                <button type="button" class="close-modal-btn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50" data-i18n-key="btn_cancel"></button>
                <button type="button" id="saveCustomColumnsBtn" class="bg-blue-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-blue-700" data-i18n-key="btn_save"></button>
            </div>
        </div>
    </div>
    
    <!-- Chart Detail Modal -->
    <div id="chartDetailModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-full overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="chartDetailModalTitle" class="text-xl font-semibold"></h3>
                <button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="chartDetailModalBody" class="p-6"></div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button type="button" class="close-modal-btn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50" data-i18n-key="btn_close"></button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Chart.js plugin registration
    Chart.register(ChartDataLabels);

    // --- I18n Data ---
    const i18n = {
        'en': {
            'nav_dashboard': 'Dashboard', 'nav_policies': 'Policy Management', 'nav_claims': 'Claims Management', 'nav_users': 'User & Permissions', 'nav_logs': 'Log Management', 'currentUser': 'Current User', 'dashboard_title': 'Dashboard', 'action_items_title': 'Action Items (Risk Alerts)', 'table_priority': 'Priority', 'table_item': 'Item', 'table_related_policy': 'Related Policy', 'table_due_date': 'Due/Event Date', 'policy_management_title': 'Policy Management', 'placeholder_search_policies': 'Search policies...', 'btn_new_policy': 'New Policy', 'claims_management_title': 'Claims Management', 'placeholder_search_claims': 'Search claims...', 'table_claim_id': 'Claim ID', 'table_policy_id': 'Policy ID', 'table_claim_date': 'Claim Date', 'table_claimed_amount': 'Claimed Amount', 'table_status': 'Status', 'table_actions': 'Actions', 'user_management_title': 'User & Permissions Management', 'placeholder_search_users': 'Search users...', 'table_user_id': 'User ID', 'table_username': 'Username', 'table_role': 'Role', 'table_region': 'Assigned Region', 'modal_add_policy_title': 'Add New Policy', 'modal_edit_policy_title': 'Edit Policy', 'form_policy_id': 'Policy ID', 'btn_cancel': 'Cancel', 'btn_save': 'Save', 'alert_confirm_delete': 'Are you sure you want to delete this item?', 'label_switch_user': 'Switch User', 'btn_new_claim': 'New Claim', 'modal_add_claim_title': 'Submit New Claim', 'modal_edit_claim_title': 'Edit Claim', 'modal_claim_detail_title': 'Claim Details', 'form_claim_date': 'Claim Date', 'form_claimed_amount': 'Claimed Amount', 'form_currency': 'Currency', 'form_accident_type': 'Accident Type / Description', 'form_insurance_type': 'Insurance Type', 'form_entity': 'Legal Entity', 'form_insurer': 'Lead Insurer', 'form_coverage_amount': 'Coverage Amount', 'form_premium': 'Premium', 'form_deductible': 'Deductible', 'form_start_date': 'Start Date', 'form_end_date': 'End Date', 'form_status': 'Status', 'msg_no_action_items': 'No urgent action items.', 'btn_ok': 'OK', 'filter_all_entities': 'All Entities', 'filter_all_types': 'All Types', 'filter_all_statuses': 'All Statuses', 'status_active': 'Active', 'status_pending': 'Pending', 'status_expired': 'Expired', 'status_approved': 'Approved', 'status_rejected': 'Rejected', 'status_pending_approval': 'Pending Approval', 'status_settled': 'Settled', 'status_in_progress': 'In Progress', 'status_not_applicable': 'Not Applicable', 'status_paid': 'Paid', 'col_policy_id': 'Policy ID', 'col_type': 'Type', 'col_entity': 'Entity', 'col_primary_insurer': 'Lead Insurer', 'col_insured_amount': 'Insured Amount', 'col_premium': 'Premium', 'col_start_date': 'Start Date', 'col_due_date': 'Due Date', 'col_status': 'Status', 'col_actions': 'Actions', 'form_is_coinsurance': 'Is Co-insurance?', 'label_coinsurance_details': 'Co-insurance Details', 'btn_add_coinsurer': 'Add Co-insurer', 'form_coinsurer': 'Co-insurer', 'form_coinsurance_ratio': 'Ratio (%)', 'alert_coinsurance_ratio_sum_error': 'The sum of the co-insurers ratios must be less than 100%.', 'nav_insurers': 'Insurer Management', 'insurer_management_title': 'Insurer Management', 'placeholder_search_insurers': 'Search insurers...', 'btn_new_insurer': 'New Insurer', 'table_insurer_id': 'Insurer ID', 'table_insurer_name': 'Insurer Name', 'form_insurer_id': 'Insurer ID', 'form_insurer_name': 'Insurer Name', 'modal_add_insurer_title': 'Add New Insurer', 'modal_edit_insurer_title': 'Edit Insurer', 'alert_confirm_delete_insurer': 'Are you sure you want to delete this insurer?', 'modal_edit_user_title': 'Edit User', 'filter_all_insurers': 'All Insurers', 'log_management_title': 'Log Management', 'table_timestamp': 'Timestamp', 'table_user': 'User', 'table_action_log': 'Action', 'table_details': 'Details', 'approval_workflow_title': 'Approval Workflow', 'table_item_id': 'Item ID', 'table_type': 'Type', 'table_created_by': 'Created By', 'table_created_date': 'Created Date', 'btn_approve': 'Approve', 'btn_reject': 'Reject', 'msg_no_approval_items': 'No items awaiting your approval.', 'modal_policy_detail_title': 'Policy Details', 'btn_close': 'Close', 'form_attached_file': 'Attached File', 'form_location_of_loss': 'Location of Loss', 'form_incident_description': 'Incident Description', 'form_reporting_manager': 'Reporting Manager', 'form_payment_status': 'Payment Status', 'form_photo_evidence': 'Photo Evidence', 'table_location_of_loss': 'Location of Loss', 'table_payment_status': 'Payment Status',
            'stat_active_policies': 'Active Policies', 'stat_total_coverage': 'Total Coverage', 'stat_total_premium': 'Total Premium', 'stat_ytd_claims': 'Claims (YTD)',
            'chart_policy_by_region': 'Active Policies by Region', 'chart_coverage_by_insurer': 'Coverage by Insurer', 'chart_premium_by_insurer': 'Premium by Insurer', 'chart_coverage_by_type': 'Coverage by Policy Type', 'chart_premium_by_type': 'Premium by Policy Type', 'chart_claims_trend': 'Claims Time Series Trend', 'chart_policy_by_due_month': 'Policies by Due Month',
            'form_insured_object': 'Insured Object', 'form_is_rider_to_fire': 'Is Rider to Fire Policy', 'form_earthquake_coverage': 'Earthquake Coverage', 'form_payment_terms': 'Payment Terms', 'form_equipment_id': 'Equipment ID / Name', 'form_maintenance_record_req': 'Maintenance Record Requirement', 'form_installation_site': 'Installation Site', 'form_waiting_period': 'Waiting Period', 'form_compensation_basis': 'Compensation Basis', 'form_daily_total_limit': 'Daily/Total Limit', 'form_transport_mode': 'Transport Mode', 'form_from_to_location': 'From / To Location', 'form_declaration_type': 'Declaration Type', 'form_packing_terms': 'Packing Terms', 'form_loading_unloading_terms': 'Loading/Unloading Terms', 'form_general_liability_scope': 'General Liability Scope', 'form_per_occurrence_limit': 'Per Occurrence Limit', 'form_aggregate_limit': 'Aggregate Limit', 'form_territorial_limit': 'Territorial Limit', 'form_product_liability_scope': 'Product Liability Scope', 'form_territorial_coverage': 'Territorial Coverage', 'form_retroactive_period': 'Retroactive Period', 'form_legal_defense_included': 'Legal Defense Included', 'form_employee_scope': 'Employee Scope', 'form_coverage_limits': 'Coverage Limits', 'form_overlap_labor_insurance': 'Overlap with Labor Insurance',
            'type_fire_insurance': 'Fire Insurance', 'type_earthquake_insurance': 'Earthquake Insurance', 'type_machinery_breakdown': 'Machinery Breakdown', 'type_business_interruption': 'Business Interruption', 'type_cargotransit_insurance': 'Cargo/Transit Insurance', 'type_public_liability': 'Public Liability', 'type_product_liability': 'Product Liability', 'type_employers_liability': 'Employer’s Liability',
            'btn_customize_columns': 'Customize Columns', 'modal_customize_columns_title': 'Customize Columns', 'label_column_order': 'Column Order (Drag to reorder)',
            'modal_due_policies_title': 'Policies Due in', 'col_claim_id': 'Claim ID', 'col_claim_date': 'Claim Date', 'col_location_of_loss': 'Location of Loss', 'col_claimed_amount': 'Claimed Amount', 'col_payment_status': 'Payment Status', 'col_claim_status': 'Claim Status', 'btn_coverage': 'Coverage', 'btn_premium': 'Premium',
        },
        'zh-TW': {
            'nav_dashboard': '儀表板', 'nav_policies': '保單管理', 'nav_claims': '理賠管理', 'nav_users': '使用者與權限', 'nav_logs': '日誌管理', 'currentUser': '目前使用者', 'dashboard_title': '儀表板', 'action_items_title': '待辦事項 (風險預警)', 'table_priority': '優先級', 'table_item': '項目', 'table_related_policy': '關聯保單', 'table_due_date': '到期/事件日', 'policy_management_title': '保單管理', 'placeholder_search_policies': '搜尋保單...', 'btn_new_policy': '新增保單', 'claims_management_title': '理賠管理', 'placeholder_search_claims': '搜尋理賠案件...', 'table_claim_id': '理賠單號', 'table_policy_id': '保單號碼', 'table_claim_date': '理賠申請日', 'table_claimed_amount': '申請金額', 'table_status': '狀態', 'table_actions': '操作', 'user_management_title': '使用者與權限管理', 'placeholder_search_users': '搜尋使用者...', 'table_user_id': '使用者ID', 'table_username': '使用者名稱', 'table_role': '角色', 'table_region': '負責區域', 'modal_add_policy_title': '新增保單', 'modal_edit_policy_title': '編輯保單', 'form_policy_id': '保單號碼', 'btn_cancel': '取消', 'btn_save': '儲存', 'alert_confirm_delete': '您確定要刪除此項目嗎？', 'label_switch_user': '切換使用者', 'btn_new_claim': '新增理賠', 'modal_add_claim_title': '提交新理賠', 'modal_edit_claim_title': '編輯理賠', 'modal_claim_detail_title': '理賠詳情', 'form_claim_date': '理賠申請日', 'form_claimed_amount': '申請金額', 'form_currency': '幣別', 'form_accident_type': '事故類型/描述', 'form_insurance_type': '險種類型', 'form_entity': '法人實體', 'form_insurer': '首席保險公司', 'form_coverage_amount': '保額', 'form_premium': '保費', 'form_deductible': '自負額', 'form_start_date': '起始日期', 'form_end_date': '結束日期', 'form_status': '狀態', 'msg_no_action_items': '沒有緊急待辦事項。', 'btn_ok': '確定', 'filter_all_entities': '所有實體', 'filter_all_types': '所有險種', 'filter_all_statuses': '所有狀態', 'status_active': '生效中', 'status_pending': '待處理', 'status_expired': '已到期', 'status_approved': '已簽核', 'status_rejected': '已拒絕', 'status_pending_approval': '待簽核', 'status_settled': '已結案', 'status_in_progress': '處理中', 'status_not_applicable': '不適用', 'status_paid': '已支付', 'col_policy_id': '保單號碼', 'col_type': '險種', 'col_entity': '實體', 'col_primary_insurer': '首席保險人', 'col_insured_amount': '保額', 'col_premium': '保費', 'col_start_date': '起始日期', 'col_due_date': '到期日期', 'col_status': '狀態', 'col_actions': '操作', 'form_is_coinsurance': '是否為共保？', 'label_coinsurance_details': '共保細節', 'btn_add_coinsurer': '新增共保人', 'form_coinsurer': '共保人', 'form_coinsurance_ratio': '比例 (%)', 'alert_coinsurance_ratio_sum_error': '共保公司的比例總和必須小於 100%。', 'nav_insurers': '保險公司管理', 'insurer_management_title': '保險人管理', 'placeholder_search_insurers': '搜尋保險公司...', 'btn_new_insurer': '新增保險公司', 'table_insurer_id': '保險公司ID', 'table_insurer_name': '保險公司名稱', 'form_insurer_id': '保險公司ID', 'form_insurer_name': '保險公司名稱', 'modal_add_insurer_title': '新增保險公司', 'modal_edit_insurer_title': '編輯保險公司', 'alert_confirm_delete_insurer': '您確定要刪除這家保險公司嗎？', 'modal_edit_user_title': '編輯使用者', 'filter_all_insurers': '所有保險公司', 'log_management_title': '日誌管理', 'table_timestamp': '時間戳', 'table_user': '使用者', 'table_action_log': '操作', 'table_details': '詳細資訊', 'approval_workflow_title': '簽核流程', 'table_item_id': '項目單號', 'table_type': '類型', 'table_created_by': '建立者', 'table_created_date': '建立日期', 'btn_approve': '同意', 'btn_reject': '拒絕', 'msg_no_approval_items': '沒有待您簽核的項目。', 'modal_policy_detail_title': '保單詳情', 'btn_close': '關閉', 'form_attached_file': '附件', 'form_location_of_loss': '損失地點', 'form_incident_description': '事故描述', 'form_reporting_manager': '通報主管', 'form_payment_status': '賠款狀態', 'form_photo_evidence': '照片證據', 'table_location_of_loss': '損失地點', 'table_payment_status': '賠款狀態',
            'stat_active_policies': '有效保單', 'stat_total_coverage': '總保額', 'stat_total_premium': '總保費', 'stat_ytd_claims': '理賠 (本年)',
            'chart_policy_by_region': '各地區有效保單數量', 'chart_coverage_by_insurer': '依保險公司統計保額', 'chart_premium_by_insurer': '依保險公司統計保費', 'chart_coverage_by_type': '各險種保額分佈', 'chart_premium_by_type': '各險種保費分佈', 'chart_claims_trend': '理賠趨勢圖', 'chart_policy_by_due_month': '保單到期月份分佈',
            'form_insured_object': '保險標的', 'form_is_rider_to_fire': '是否為附加條款', 'form_earthquake_coverage': '地震附加保額', 'form_payment_terms': '給付條件', 'form_equipment_id': '設備名稱/編號', 'form_maintenance_record_req': '維修紀錄要求', 'form_installation_site': '裝設地點', 'form_waiting_period': '等待期間', 'form_compensation_basis': '賠償方式', 'form_daily_total_limit': '最高日額與總額限制', 'form_transport_mode': '運輸方式', 'form_from_to_location': '起訖地點', 'form_declaration_type': '投保方式', 'form_packing_terms': '包裝要求', 'form_loading_unloading_terms': '裝卸條件與風險轉移時點', 'form_general_liability_scope': '一般責任範圍', 'form_per_occurrence_limit': '每次事故限額', 'form_aggregate_limit': '年度總額限額', 'form_territorial_limit': '承保區域', 'form_product_liability_scope': '產品責任範圍', 'form_territorial_coverage': '地區範圍', 'form_retroactive_period': '回溯期間', 'form_legal_defense_included': '法律訴訟責任支援', 'form_employee_scope': '員工適用範圍', 'form_coverage_limits': '保額限制', 'form_overlap_labor_insurance': '是否重疊勞保補償',
            'type_fire_insurance': '火災保險', 'type_earthquake_insurance': '地震保險', 'type_machinery_breakdown': '機械險', 'type_business_interruption': '營業中斷險', 'type_cargotransit_insurance': '貨物運輸險', 'type_public_liability': '公共意外責任險', 'type_product_liability': '產品責任險', 'type_employers_liability': '雇主責任險',
            'btn_customize_columns': '自訂欄位', 'modal_customize_columns_title': '自訂欄位', 'label_column_order': '欄位排序 (拖曳)',
            'modal_due_policies_title': '於...到期的保單', 'col_claim_id': '理賠單號', 'col_claim_date': '理賠日', 'col_location_of_loss': '損失地點', 'col_claimed_amount': '申請金額', 'col_payment_status': '賠款狀態', 'col_claim_status': '理賠狀態', 'btn_coverage': '保額', 'btn_premium': '保費',
        },
        'ja': {
            'nav_dashboard': 'ダッシュボード', 'nav_policies': '保険契約管理', 'nav_claims': '保険金請求管理', 'nav_users': 'ユーザーと権限', 'nav_logs': 'ログ管理', 'currentUser': '現在のユーザー', 'dashboard_title': 'ダッシュボード', 'action_items_title': 'アクションアイテム（リスク警告）', 'table_priority': '優先度', 'table_item': '項目', 'table_related_policy': '関連契約', 'table_due_date': '期日/イベント日', 'policy_management_title': '保険契約管理', 'placeholder_search_policies': '保険契約を検索...', 'btn_new_policy': '新規契約', 'claims_management_title': '保険金請求管理', 'placeholder_search_claims': '保険金請求を検索...', 'table_claim_id': '請求ID', 'table_policy_id': '契約ID', 'table_claim_date': '請求日', 'table_claimed_amount': '請求額', 'table_status': 'ステータス', 'table_actions': '操作', 'user_management_title': 'ユーザーと権限管理', 'placeholder_search_users': 'ユーザーを検索...', 'table_user_id': 'ユーザーID', 'table_username': 'ユーザー名', 'table_role': '役割', 'table_region': '担当地域', 'modal_add_policy_title': '新規契約追加', 'modal_edit_policy_title': '契約を編集', 'form_policy_id': '契約番号', 'btn_cancel': 'キャンセル', 'btn_save': '保存', 'alert_confirm_delete': 'この項目を削除してもよろしいですか？', 'label_switch_user': 'ユーザー切り替え', 'btn_new_claim': '新規請求', 'modal_add_claim_title': '新規保険金請求の提出', 'modal_edit_claim_title': '請求を編集', 'modal_claim_detail_title': '請求詳細', 'form_claim_date': '請求日', 'form_claimed_amount': '請求額', 'form_currency': '通貨', 'form_accident_type': '事故の種類/説明', 'form_insurance_type': '保険種類', 'form_entity': '法人', 'form_insurer': '主幹事保険会社', 'form_coverage_amount': '保険金額', 'form_premium': '保険料', 'form_deductible': '免責金額', 'form_start_date': '開始日', 'form_end_date': '終了日', 'form_status': 'ステータス', 'msg_no_action_items': '緊急のアクションアイテムはありません。', 'btn_ok': 'OK', 'filter_all_entities': 'すべてのエンティティ', 'filter_all_types': 'すべての種類', 'filter_all_statuses': 'すべてのステータス', 'status_active': '有効', 'status_pending': '保留中', 'status_expired': '期限切れ', 'status_approved': '承認済み', 'status_rejected': '拒否済み', 'status_pending_approval': '承認待ち', 'status_settled': '解決済み', 'status_in_progress': '処理中', 'status_not_applicable': '該当なし', 'status_paid': '支払済み', 'col_policy_id': '保険契約ID', 'col_type': '種類', 'col_entity': 'エンティティ', 'col_primary_insurer': '主幹事保険会社', 'col_insured_amount': '保険金額', 'col_premium': '保険料', 'col_start_date': '開始日', 'col_due_date': '期日', 'col_status': 'ステータス', 'col_actions': '操作', 'form_is_coinsurance': '共同保険ですか？', 'label_coinsurance_details': '共同保険の詳細', 'btn_add_coinsurer': '共同保険会社を追加', 'form_coinsurer': '共同保険会社', 'form_coinsurance_ratio': '比率 (%)',
            'alert_coinsurance_ratio_sum_error': '共同保険会社の比率の合計は100%未満でなければなりません。',
            'nav_insurers': '保険会社管理', 'insurer_management_title': '保険会社管理', 'placeholder_search_insurers': '保険会社を検索...', 'btn_new_insurer': '新規保険会社', 'table_insurer_id': '保険会社ID', 'table_insurer_name': '保険会社名', 'form_insurer_id': '保険会社ID', 'form_insurer_name': '保険会社名', 'modal_add_insurer_title': '新規保険会社追加', 'modal_edit_insurer_title': '保険会社を編集', 'alert_confirm_delete_insurer': 'この保険会社を削除してもよろしいですか？', 'modal_edit_user_title': 'ユーザーを編集', 'filter_all_insurers': 'すべての保険会社', 'log_management_title': 'ログ管理', 'table_timestamp': 'タイムスタンプ', 'table_user': 'ユーザー', 'table_action_log': 'アクション', 'table_details': '詳細', 'approval_workflow_title': '承認ワークフロー', 'table_item_id': 'アイテムID', 'table_type': 'タイプ', 'table_created_by': '作成者', 'table_created_date': '作成日', 'btn_approve': '承認', 'btn_reject': '拒否', 'msg_no_approval_items': '承認待ちのアイテムはありません。', 'modal_policy_detail_title': '保険契約詳細', 'btn_close': '閉じる', 'form_attached_file': '添付ファイル', 'form_location_of_loss': '損害発生場所', 'form_incident_description': '事故内容', 'form_reporting_manager': '報告責任者', 'form_payment_status': '支払状況', 'form_photo_evidence': '証拠写真', 'table_location_of_loss': '損害発生場所', 'table_payment_status': '支払状況',
            'stat_active_policies': '有効な契約', 'stat_total_coverage': '総補償額', 'stat_total_premium': '総保険料', 'stat_ytd_claims': '保険金請求 (今年)',
            'chart_policy_by_region': '地域別の有効な契約', 'chart_coverage_by_insurer': '保険会社別補償額', 'chart_premium_by_insurer': '保険会社別保険料', 'chart_coverage_by_type': '保険種類別補償額', 'chart_premium_by_type': '保険種類別保険料', 'chart_claims_trend': '保険金請求時系列トレンド', 'chart_policy_by_due_month': '満期月別契約数',
            'form_insured_object': '保険対象', 'form_is_rider_to_fire': '火災保険の特約', 'form_earthquake_coverage': '地震保険の補償額', 'form_payment_terms': '支払条件', 'form_equipment_id': '設備名/ID', 'form_maintenance_record_req': 'メンテナンス記録要件', 'form_installation_site': '設置場所', 'form_waiting_period': '待機期間', 'form_compensation_basis': '補償基準', 'form_daily_total_limit': '日額/総額上限', 'form_transport_mode': '輸送モード', 'form_from_to_location': '出発地 / 到着地', 'form_declaration_type': '申告タイプ', 'form_packing_terms': '梱包条件', 'form_loading_unloading_terms': '荷役条件', 'form_general_liability_scope': '一般賠償責任範囲', 'form_per_occurrence_limit': '1事故あたりの限度額', 'form_aggregate_limit': '年間総額限度額', 'form_territorial_limit': '地域制限', 'form_product_liability_scope': '製品賠償責任範囲', 'form_territorial_coverage': '地域範囲', 'form_retroactive_period': '遡及期間', 'form_legal_defense_included': '法的弁護のサポート', 'form_employee_scope': '従業員適用範囲', 'form_coverage_limits': '補償限度額', 'form_overlap_labor_insurance': '労働保険との重複',
            'type_fire_insurance': '火災保険', 'type_earthquake_insurance': '地震保険', 'type_machinery_breakdown': '機械保険', 'type_business_interruption': '休業保険', 'type_cargotransit_insurance': '貨物海上保険', 'type_public_liability': '賠償責任保険', 'type_product_liability': '生産物賠償責任保険', 'type_employers_liability': '使用者賠償責任保険',
            'btn_customize_columns': '列のカスタマイズ', 'modal_customize_columns_title': '列のカスタマイズ', 'label_column_order': '列の順序 (ドラッグ)',
            'modal_due_policies_title': '...に満期を迎える契約', 'col_claim_id': '請求ID', 'col_claim_date': '請求日', 'col_location_of_loss': '損害発生場所', 'col_claimed_amount': '請求額', 'col_payment_status': '支払状況', 'col_claim_status': '請求ステータス', 'btn_coverage': '補償額', 'btn_premium': '保険料',
        }
    };
    
    let currentLanguage = 'en';
    let currentUser = null;

    // --- Data Definition & Generation ---
    const regions = ['US', 'JP', 'CN', 'TW', 'EU'];
    const insuranceTypes = [
        { id: 1, name: 'Fire Insurance' }, { id: 2, name: 'Earthquake Insurance' },
        { id: 3, name: 'Machinery Breakdown' }, { id: 4, name: 'Business Interruption' },
        { id: 5, 'name': 'Cargo/Transit Insurance' }, { id: 6, name: 'Public Liability' },
        { id: 7, name: 'Product Liability' }, { id: 8, name: 'Employer’s Liability' }
    ];
    let insurers = [
        { insurer_id: 'INS-AIG', name: 'AIG', region: 'Global' }, { insurer_id: 'INS-CHUBB', name: 'Chubb', region: 'Global' },
        { insurer_id: 'INS-ALLIANZ', name: 'Allianz', region: 'EU' }, { insurer_id: 'INS-TOKIO', name: 'Tokio Marine', region: 'JP' },
        { insurer_id: 'INS-PICC', name: 'PICC', region: 'CN' }, { insurer_id: 'INS-HARTFORD', name: 'The Hartford', region: 'US' },
        { insurer_id: 'INS-CATHAY', name: 'Cathay Fubon', region: 'TW' }, { insurer_id: 'INS-FUBON', name: 'Fubon Insurance', region: 'TW' }
    ];
    const legalEntities = [
        { entity_id: 'US-Entity-A', entity_name: 'US Operations LLC', country_code: 'US' },
        { entity_id: 'JP-Entity-A', entity_name: 'Japan Branch GK', country_code: 'JP' },
        { entity_id: 'CN-Entity-A', entity_name: 'China Manufacturing Co.', country_code: 'CN' },
        { entity_id: 'TW-Entity-A', entity_name: 'Taiwan HQ Corp.', country_code: 'TW' },
        { entity_id: 'EU-Entity-A', entity_name: 'Europe Distribution GmbH', country_code: 'DE' },
    ];

    const generateMockData = () => {
        let users = [ { user_id: 'U001', username: 'Admin (HQ)', role_id: 1, assigned_region: 'HQ' } ];
        let policies = [];
        let claims = [];
        let userCounter = 2;

        regions.forEach(region => {
            const manager = { user_id: `U${String(userCounter++).padStart(3, '0')}`, username: `${region} Manager`, role_id: 2, assigned_region: region };
            const user = { user_id: `U${String(userCounter++).padStart(3, '0')}`, username: `${region} User`, role_id: 3, assigned_region: region };
            users.push(manager, user);
            
            const regionEntity = legalEntities.find(e => e.country_code === (region === 'EU' ? 'DE' : region));
            if (!regionEntity) return;

            insuranceTypes.forEach(type => {
                for (let i = 1; i <= 15; i++) { 
                    const startDate = new Date(2023 + Math.floor(Math.random() * 2), Math.floor(Math.random() * 12), 1);
                    const endDate = new Date(startDate.getFullYear() + (Math.random() > 0.1 ? 1 : 2), startDate.getMonth(), startDate.getDate() -1);
                    const approvalStatus = ['Approved', 'Pending Approval', 'Rejected'][Math.floor(Math.random() * 3)];
                    let status = 'Pending';
                    if (approvalStatus === 'Approved') {
                        status = new Date() > endDate ? 'Expired' : 'Active';
                    }

                    const isCoinsurance = Math.random() > 0.5;
                    const regionInsurers = insurers.filter(ins => ins.region === region || ins.region === 'Global');
                    const primaryInsurer = regionInsurers[Math.floor(Math.random() * regionInsurers.length)];
                    let coinsuranceDetails = [];

                    if (isCoinsurance && regionInsurers.length > 1) {
                        let remainingRatio = 100;
                        let leadRatio = Math.floor(Math.random() * 41) + 40;
                        remainingRatio -= leadRatio;
                        
                        const availableFollowers = regionInsurers.filter(ins => ins.insurer_id !== primaryInsurer.insurer_id);
                        if (availableFollowers.length > 0) {
                            const follower = availableFollowers[Math.floor(Math.random() * availableFollowers.length)];
                            coinsuranceDetails.push({ insurer_id: follower.insurer_id, ratio: remainingRatio });
                        } else { 
                            leadRatio = 100;
                        }
                    }

                    const creator = Math.random() > 0.5 ? manager : user;
                    const currency = {US: 'USD', JP: 'JPY', CN: 'CNY', TW: 'TWD', EU: 'EUR'}[region] || 'USD';

                    const policy = {
                        policy_id: `${type.name.substring(0,4).toUpperCase()}-${region}-${2024+i-1}-${String(policies.length+1).padStart(4,'0')}`,
                        entity_id: regionEntity.entity_id,
                        insurer_id: primaryInsurer.insurer_id,
                        is_coinsurance: isCoinsurance,
                        coinsurers: coinsuranceDetails,
                        insurance_type_id: type.id,
                        currency_code: currency,
                        coverage_amount: Math.floor(Math.random() * 1000000) * 100,
                        premium: Math.floor(Math.random() * 5000) * 10,
                        deductible: Math.floor(Math.random() * 1000) * 5,
                        start_date: startDate.toISOString().split('T')[0],
                        end_date: endDate.toISOString().split('T')[0],
                        status: status,
                        approval_status: approvalStatus,
                        created_by: creator.user_id,
                        created_date: new Date(Date.now() - Math.floor(Math.random() * 365 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                        approved_by: approvalStatus === 'Approved' ? (creator.role_id === 2 ? user.user_id : manager.user_id) : null,
                        attached_file: `policy_doc_${policies.length + 1}.pdf`,
                        insured_object: type.id === 1 ? `${region} Factory & Equipment` : null,
                        is_rider_to_fire: type.id === 2 ? (Math.random() > 0.5) : null,
                        earthquake_coverage: type.id === 2 ? Math.floor(Math.random() * 500000) * 100 : null,
                        payment_terms: type.id === 2 ? 'Richter scale > 5.0' : null,
                        equipment_id: type.id === 3 ? `CNC-Machine-${region}-${i}` : null,
                        maintenance_record_req: type.id === 3 ? (Math.random() > 0.5) : null,
                        installation_site: type.id === 3 ? `${region} Plant, Unit ${i}` : null,
                        waiting_period: type.id === 4 ? `${[7,14,30][Math.floor(Math.random()*3)]} days` : null,
                        compensation_basis: type.id === 4 ? ['Gross Profit', 'Revenue Loss'][Math.floor(Math.random()*2)] : null,
                        daily_total_limit: type.id === 4 ? `${(Math.random()*10000).toFixed(0)} / ${(Math.random()*100000).toFixed(0)}` : null,
                        transport_mode: type.id === 5 ? ['Sea', 'Air', 'Land'][Math.floor(Math.random()*3)] : null,
                        from_to_location: type.id === 5 ? `Port of ${region} to Port of Destination` : null,
                        declaration_type: type.id === 5 ? ['Per Shipment', 'Annual'][Math.floor(Math.random()*2)] : null,
                        packing_terms: type.id === 5 ? 'Standard Export Crating' : null,
                        loading_unloading_terms: type.id === 5 ? 'FOB' : null,
                        general_liability_scope: type.id === 6 ? 'Third-party bodily injury and property damage' : null,
                        per_occurrence_limit: type.id === 6 ? [1000000, 2000000, 5000000][Math.floor(Math.random()*3)] : null,
                        aggregate_limit: type.id === 6 ? [5000000, 10000000][Math.floor(Math.random()*2)] : null,
                        territorial_limit: type.id === 6 ? 'Worldwide excl. US/Canada' : null,
                        product_liability_scope: type.id === 7 ? 'All manufactured products' : null,
                        territorial_coverage: type.id === 7 ? 'Worldwide' : null,
                        retroactive_period: type.id === 7 ? `${[1,2,5][Math.floor(Math.random()*3)]} years` : null,
                        legal_defense_included: type.id === 7 ? (Math.random() > 0.5) : null,
                        employee_scope: type.id === 8 ? 'All full-time employees' : null,
                        coverage_limits: type.id === 8 ? '1,000,000 per employee / 5,000,000 per event' : null,
                        overlap_labor_insurance: type.id === 8 ? (Math.random() > 0.5) : null,
                    };
                    policies.push(policy);

                    if(status === 'Active' && Math.random() > 0.4) {
                         const claimCreator = Math.random() > 0.5 ? manager : user;
                         const claimApprovalStatus = ['Approved', 'Pending Approval', 'Rejected'][Math.floor(Math.random() * 3)];
                         const claimDate = new Date(startDate.getTime() + Math.random() * (new Date().getTime() - startDate.getTime()));
                         claims.push({
                            claim_id: `C${claimDate.getFullYear()}-${String(claims.length+1).padStart(4,'0')}`,
                            policy_id: policy.policy_id,
                            claim_date: claimDate.toISOString().split('T')[0],
                            claimed_amount: Math.floor(Math.random() * policy.premium * 2),
                            currency_code: policy.currency_code,
                            status: claimApprovalStatus === 'Approved' ? ['Settled', 'In Progress', 'Rejected'][Math.floor(Math.random()*3)] : 'Pending',
                            approval_status: claimApprovalStatus,
                            created_by: claimCreator.user_id,
                            created_date: claimDate.toISOString().split('T')[0],
                            approved_by: claimApprovalStatus === 'Approved' ? (claimCreator.role_id === 2 ? user.user_id : manager.user_id) : null,
                            location_of_loss: `${region} Plant, Unit ${i}`,
                            incident_description: `Incident related to ${type.name} operation. Assessment required.`,
                            reporting_manager: manager.username,
                            payment_status: ['Paid', 'Pending', 'Not Applicable'][Math.floor(Math.random()*3)],
                            photo_evidence: `claim_photo_${claims.length + 1}.jpg`
                        });
                    }
                }
            });
        });
        return { users, policies, claims };
    };
    
    // --- Application State ---
    const initialData = generateMockData();
    const state = {
        ...initialData,
        roles: [ { role_id: 1, role_name: 'HQ' }, { role_id: 2, role_name: 'RegionAdmin' }, { role_id: 3, role_name: 'User' } ],
        legalEntities, insurers, insuranceTypes,
        auditLogs: [], charts: {},
        insurerChartMetric: 'coverage',
        typeChartMetric: 'coverage',
        policyTableColumns: [
            { key: 'policy_id', labelKey: 'col_policy_id', sortable: true, visible: true },
            { key: 'insurance_type_id', labelKey: 'col_type', sortable: true, visible: true, formatter: (id) => state.insuranceTypes.find(t => t.id === id)?.name || 'N/A' },
            { key: 'insurer_id', labelKey: 'col_primary_insurer', sortable: true, visible: true, formatter: (id, policy) => {
                const primary = state.insurers.find(i => i.insurer_id === id)?.name || 'N/A';
                return policy.is_coinsurance ? `${primary} <span class="text-blue-500 font-bold" title="Co-insurance">★</span>` : primary;
            }},
            { key: 'entity_id', labelKey: 'col_entity', sortable: true, visible: true, formatter: (id) => state.legalEntities.find(e => e.entity_id === id)?.entity_name || 'N/A' },
            { key: 'coverage_amount', labelKey: 'col_insured_amount', sortable: true, visible: true, formatter: (amount, policy) => `${amount.toLocaleString()} ${policy.currency_code}` },
            { key: 'premium', labelKey: 'col_premium', sortable: true, visible: true, formatter: (amount, policy) => `${amount.toLocaleString()} ${policy.currency_code}` },
            { key: 'end_date', labelKey: 'col_due_date', sortable: true, visible: true },
            { key: 'status', labelKey: 'col_status', sortable: true, visible: true, formatter: (status, policy) => getStatusBadge(policy.approval_status !== 'Approved' ? policy.approval_status : status) },
        ],
        claimsTableColumns: [
            { key: 'claim_id', labelKey: 'col_claim_id', sortable: true, visible: true },
            { key: 'policy_id', labelKey: 'table_policy_id', sortable: true, visible: true },
            { key: 'claim_date', labelKey: 'col_claim_date', sortable: true, visible: true },
            { key: 'location_of_loss', labelKey: 'col_location_of_loss', sortable: true, visible: true },
            { key: 'claimed_amount', labelKey: 'col_claimed_amount', sortable: true, visible: true, formatter: (amount, claim) => `${amount.toLocaleString()} ${claim.currency_code}` },
            { key: 'payment_status', labelKey: 'col_payment_status', sortable: true, visible: true, formatter: (status) => getStatusBadge(status) },
            { key: 'status', labelKey: 'col_claim_status', sortable: true, visible: true, formatter: (status, claim) => getStatusBadge(claim.approval_status !== 'Approved' ? claim.approval_status : claim.status) },
        ],
        policySort: { key: 'policy_id', direction: 'asc' },
        claimSort: { key: 'claim_id', direction: 'asc' },
    };

    // --- Utility Functions ---
    const getStatusBadge = (status) => {
        if (!status) return '';
        const key = `status_${status.replace(/\s+/g, '_').toLowerCase()}`;
        const text = i18n[currentLanguage][key] || status;
        const colors = {
            'Active': 'bg-green-100 text-green-800', 'Approved': 'bg-green-100 text-green-800', 'Settled': 'bg-green-100 text-green-800', 'Paid': 'bg-green-100 text-green-800',
            'Pending Approval': 'bg-blue-100 text-blue-800',
            'Pending': 'bg-yellow-100 text-yellow-800', 'In Progress': 'bg-yellow-100 text-yellow-800',
            'Expired': 'bg-gray-200 text-gray-800', 
            'Rejected': 'bg-red-100 text-red-800',
            'Not Applicable': 'bg-gray-100 text-gray-700'
        };
        const colorClass = Object.keys(colors).find(k => k.toLowerCase() === status.toLowerCase());
        return `<span class="px-2 py-1 text-xs font-medium rounded-full inline-block ${colors[colorClass] || 'bg-gray-100 text-gray-800'}">${text}</span>`;
    };
    
    const logAction = (action, details = '') => {
        if (!currentUser) return;
        state.auditLogs.unshift({
            timestamp: new Date().toISOString(),
            user: currentUser.username,
            action: action,
            details: details
        });
        if (document.getElementById('logs-view').classList.contains('active')) {
            logControls.renderTable(state.auditLogs);
        }
    };

    // --- UI Control & Initialization ---
    const userSwitcher = document.getElementById('user-switcher');
    const langSwitcher = document.getElementById('language-switcher');
    const currentUserDisplay = document.getElementById('currentUserDisplay');

    const setupSwitchers = () => {
        userSwitcher.innerHTML = state.users.map(u => `<option value="${u.user_id}">${u.username}</option>`).join('');
        userSwitcher.value = state.users[0].user_id;
        currentUser = state.users[0];
        userSwitcher.addEventListener('change', () => {
            currentUser = state.users.find(u => u.user_id === userSwitcher.value);
            updateAppForUser();
        });

        langSwitcher.addEventListener('click', (e) => {
            e.preventDefault();
            if(e.target.matches('.lang-link')) {
                currentLanguage = e.target.dataset.lang;
                updateAppForUser();
            }
        });
    };

    const updateAppForUser = () => {
        if (!currentUser) return;
        currentUserDisplay.innerHTML = `<span class="font-semibold" data-i18n-key="currentUser"></span>: ${currentUser.username} (${currentUser.assigned_region})`;
        document.documentElement.lang = currentLanguage;
        langSwitcher.querySelectorAll('.lang-link').forEach(link => {
            link.classList.toggle('active', link.dataset.lang === currentLanguage);
        });
        translateUI();
        renderAllActiveViews();
    };

    const translateUI = () => {
        const translations = i18n[currentLanguage];
        if (!translations) return;

        document.querySelectorAll('[data-i18n-key]').forEach(el => {
            const key = el.dataset.i18nKey;
            if (translations[key]) {
                 if(el.placeholder !== undefined && el.placeholder !== null) el.placeholder = translations[key];
                 else el.textContent = translations[key];
            }
        });
        
        const updateFilterOptions = (elementId, allKey, optionGenerator) => {
            const selectElement = document.getElementById(elementId);
            if (!selectElement) return;
            const currentValue = selectElement.value;
            selectElement.innerHTML = `<option value="" data-i18n-key="${allKey}">${translations[allKey]}</option>` + optionGenerator();
            selectElement.value = currentValue;
        };
        
        updateFilterOptions('policyFilterEntity', 'filter_all_entities', () => state.legalEntities.map(e => `<option value="${e.entity_id}">${e.entity_name}</option>`).join(''));
        
        updateFilterOptions('policyFilterType', 'filter_all_types', () => {
            return state.insuranceTypes.map(t => {
                const i18nKey = `type_${t.name.toLowerCase().replace(/[\s/]+/g, '_').replace(/_+$/, '')}`;
                const text = translations[i18nKey] || t.name;
                return `<option value="${t.id}">${text}</option>`;
            }).join('');
        });

        updateFilterOptions('policyFilterStatus', 'filter_all_statuses', () => {
            return ['Pending Approval', 'Approved', 'Active', 'Expired', 'Rejected'].map(s => {
                const statusKey = `status_${s.replace(/\s+/g, '_').toLowerCase()}`;
                const statusText = translations[statusKey] || s;
                return `<option value="${s}">${statusText}</option>`;
            }).join('');
        });

        updateFilterOptions('policyFilterInsurer', 'filter_all_insurers', () => state.insurers.map(i => `<option value="${i.insurer_id}">${i.name}</option>`).join(''));
    };

    const getFilteredData = () => {
        if (!currentUser || currentUser.assigned_region === 'HQ') {
            return { policies: state.policies, claims: state.claims, insurers: state.insurers, users: state.users };
        }
        const userRegionEntities = state.legalEntities
            .filter(e => e.country_code === (currentUser.assigned_region === 'EU' ? 'DE' : currentUser.assigned_region) || e.country_code === (currentUser.assigned_region === 'EU' ? 'FR' : ''))
            .map(e => e.entity_id);
            
        const filteredPolicies = state.policies.filter(p => userRegionEntities.includes(p.entity_id));
        const filteredPolicyIds = filteredPolicies.map(p => p.policy_id);
        const filteredClaims = state.claims.filter(c => filteredPolicyIds.includes(c.policy_id));
        
        return { policies: filteredPolicies, claims: filteredClaims, insurers: state.insurers, users: state.users };
    };

    const renderAllActiveViews = () => {
        const { policies, claims, insurers, users } = getFilteredData();
        const activeView = document.querySelector('.view.active');
        if (!activeView) return;

        switch(activeView.id) {
            case 'dashboard-view': dashboardControls.render(policies, claims); break;
            case 'policies-view': policyControls.renderTable(policies); break;
            case 'claims-view': claimsControls.renderTable(claims); break;
            case 'insurers-view': insurerControls.renderTable(insurers); break;
            case 'users-view': userControls.renderTable(users); break;
            case 'logs-view': logControls.renderTable(state.auditLogs); break;
        }
    };
    
    document.getElementById('sidebar-nav').addEventListener('click', (e) => {
        e.preventDefault();
        const navLink = e.target.closest('.nav-link');
        if (!navLink) return;
        const targetId = navLink.dataset.target;
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        const targetView = document.getElementById(targetId);
        if (targetView) targetView.classList.add('active');
        
        document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => {
            link.classList.remove('bg-gray-200', 'text-gray-700');
            link.classList.add('text-gray-600', 'hover:bg-gray-100');
        });
        navLink.classList.add('bg-gray-200', 'text-gray-700');
        navLink.classList.remove('text-gray-600', 'hover:bg-gray-100');
        renderAllActiveViews();
    });

    // --- Dashboard Controls ---
    const dashboardControls = {
        render(policies, claims) {
            this.renderStatCards(policies, claims);
            this.renderRegionStats(policies);
            this.renderApprovalItems(policies, claims);
            this.initAllCharts(policies, claims);
            this.setupChartToggles();
            translateUI();
        },
        renderStatCards(policies, claims) {
            const approvedPolicies = policies.filter(p => p.approval_status === 'Approved');
            const activePolicies = approvedPolicies.filter(p => p.status === 'Active');
            const totalCoverage = activePolicies.reduce((sum, p) => sum + p.coverage_amount, 0);
            const totalPremium = activePolicies.reduce((sum, p) => sum + p.premium, 0);
            
            const currentYear = new Date().getFullYear();
            const ytdClaims = claims.filter(c => new Date(c.claim_date).getFullYear() === currentYear && c.approval_status === 'Approved');
            const ytdClaimsCount = ytdClaims.length;
            const ytdClaimsAmount = ytdClaims.reduce((sum, c) => sum + c.claimed_amount, 0);

            const formatCurrency = (num) => {
                if (num >= 1_000_000_000) return (num / 1_000_000_000).toFixed(1) + 'B';
                if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + 'M';
                if (num >= 1_000) return (num / 1_000).toFixed(1) + 'K';
                return num.toLocaleString();
            };

            const statCardContainer = document.getElementById('statCardContainer');
            if(statCardContainer) {
                statCardContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-sm text-gray-500" data-i18n-key="stat_active_policies"></p><p class="text-2xl font-bold">${activePolicies.length}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-sm text-gray-500" data-i18n-key="stat_total_coverage"></p><p class="text-2xl font-bold">${formatCurrency(totalCoverage)}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-sm text-gray-500" data-i18n-key="stat_total_premium"></p><p class="text-2xl font-bold">${formatCurrency(totalPremium)}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-sm text-gray-500" data-i18n-key="stat_ytd_claims"></p><p class="text-2xl font-bold">${formatCurrency(ytdClaimsAmount)} / ${ytdClaimsCount}</p></div>
                `;
            }
        },
        renderRegionStats(policies) {
            const container = document.getElementById('regionStatsContainer');
            if (!container) return;

            const activePolicies = policies.filter(p => p.status === 'Active' && p.approval_status === 'Approved');
            
            const regionData = activePolicies.reduce((acc, p) => {
                const entity = state.legalEntities.find(e => e.entity_id === p.entity_id);
                const region = entity ? (['US', 'JP', 'CN', 'TW'].includes(entity.country_code) ? entity.country_code : 'EU') : 'Unknown';
                
                // 初始化該地區的物件（如果尚未存在）
                if (!acc[region]) {
                    acc[region] = { count: 0, coverage: 0, premium: 0 };
                }

                // 累加數量、保額和保費
                acc[region].count++;
                acc[region].coverage += p.coverage_amount;
                acc[region].premium += p.premium;
                
                return acc;
            }, {});
            
            // 格式化數字以便顯示 (e.g., 1M, 1.2B)
            const formatCompactNumber = (num) => {
                if (num >= 1_000_000_000) return (num / 1_000_000_000).toFixed(1) + 'B';
                if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + 'M';
                if (num >= 1_000) return (num / 1_000).toFixed(1) + 'K';
                return num.toString();
            };

            // 生成新的 HTML，包含 Count / Coverage / Premium
            container.innerHTML = Object.entries(regionData).map(([region, data]) => `
                <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <p class="text-base font-bold text-gray-700">${region}</p>
                    <p class="text-2xl font-bold text-blue-600">${data.count}</p>
                    <div class="text-xs text-gray-500 mt-2">
                        <span>C: ${formatCompactNumber(data.coverage)}</span> / 
                        <span>P: ${formatCompactNumber(data.premium)}</span>
                    </div>
                </div>
            `).join('');
        },
        renderApprovalItems(policies, claims) {
            const tableBody = document.getElementById('approvalItemsTableBody');
            if (!tableBody) return;
            const itemsToApprove = [];
            
            [...policies, ...claims].forEach(item => {
                if (item.approval_status === 'Pending Approval') {
                    const creator = state.users.find(u => u.user_id === item.created_by);
                    const canApprove = currentUser.role_id === 1 || (creator && creator.assigned_region === currentUser.assigned_region && creator.user_id !== currentUser.user_id);
                    if (canApprove) itemsToApprove.push(item);
                }
            });

            if (itemsToApprove.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4" data-i18n-key="msg_no_approval_items"></td></tr>`;
            } else {
                tableBody.innerHTML = itemsToApprove.map(item => {
                    const creator = state.users.find(u => u.user_id === item.created_by);
                    const isPolicy = !!item.policy_id && !item.claim_date;
                    const id = isPolicy ? item.policy_id : item.claim_id;
                    const type = isPolicy ? 'Policy' : 'Claim';
                    return `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium">${id}</td>
                            <td class="px-6 py-4">${type}</td>
                            <td class="px-6 py-4">${creator?.username || 'N/A'}</td>
                            <td class="px-6 py-4">${item.created_date}</td>
                            <td class="px-6 py-4 space-x-2">
                                <button data-id="${id}" data-type="${type.toLowerCase()}" class="approve-btn bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 text-xs" data-i18n-key="btn_approve">Approve</button>
                                <button data-id="${id}" data-type="${type.toLowerCase()}" class="reject-btn bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 text-xs" data-i18n-key="btn_reject">Reject</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            tableBody.querySelectorAll('.approve-btn, .reject-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const type = e.target.dataset.type;
                    const action = e.target.classList.contains('approve-btn') ? 'Approved' : 'Rejected';
                    this.handleApproval(id, type, action);
                });
            });
        },
        handleApproval(id, type, action) {
            const collection = type === 'policy' ? state.policies : state.claims;
            const itemKey = type === 'policy' ? 'policy_id' : 'claim_id';
            const item = collection.find(i => i[itemKey] === id);
            if (item) {
                item.approval_status = action;
                item.approved_by = currentUser.user_id;
                if (action === 'Approved' && type === 'policy') {
                    item.status = new Date() > new Date(item.end_date) ? 'Expired' : 'Active';
                }
                if (action === 'Approved' && type === 'claim') {
                    item.status = 'In Progress';
                }
                logAction(`${action} ${type}`, `${type} ID: ${id}`);
                renderAllActiveViews();
            }
        },
        chartColors: {
            palette: ['#3b82f6', '#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#8b5cf6', '#ec4899']
        },
        initAllCharts(policies, claims) {
            const { insurerChartMetric, typeChartMetric } = state;
            
            document.getElementById('insurerChartTitle').dataset.i18nKey = `chart_${insurerChartMetric}_by_insurer`;
            document.getElementById('typeChartTitle').dataset.i18nKey = `chart_${typeChartMetric}_by_type`;

            const chartOptions = {
                pieDoughnut: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum);
                                return percentage > 5 ? percentage.toFixed(0) + "%" : '';
                            },
                            color: '#fff',
                        }
                    },
                    onClick: (e) => this.handleChartClick(e)
                },
                bar: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    onClick: (e) => this.handleChartClick(e)
                },
                line: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { 
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: '# of Claims' } }, 
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Claim Amount' }, grid: { drawOnChartArea: false } } 
                    },
                    onClick: (e) => this.handleChartClick(e)
                }
            };
            
            const chartConfigs = {
                insurerChart: { type: 'doughnut', data: () => this.getInsurerData(policies), options: chartOptions.pieDoughnut },
                typeChart: { type: 'pie', data: () => this.getPolicyTypeData(policies), options: chartOptions.pieDoughnut },
                claimsTrendChart: { type: 'bar', data: () => this.getClaimsTrendData(claims), options: chartOptions.line },
                policyByDueMonthChart: { type: 'bar', data: () => this.getPolicyByDueMonthData(policies), options: chartOptions.bar }
            };

            for (const [id, config] of Object.entries(chartConfigs)) {
                const ctx = document.getElementById(id)?.getContext('2d');
                if (!ctx) continue;
                if (state.charts[id]) state.charts[id].destroy();
                state.charts[id] = new Chart(ctx, { type: config.type, data: config.data(), options: config.options });
            }
            translateUI();
        },
        getInsurerData: (policies) => {
            const activePolicies = policies.filter(p => p.status === 'Active' && p.approval_status === 'Approved');
            const metric = state.insurerChartMetric; // 'coverage' or 'premium'
            const dataKey = metric === 'coverage' ? 'coverage_amount' : 'premium';
            
            const insurerData = activePolicies.reduce((acc, p) => {
                const insurerName = state.insurers.find(i => i.insurer_id === p.insurer_id)?.name || 'Unknown';
                acc[insurerName] = (acc[insurerName] || 0) + p[dataKey];
                return acc;
            }, {});

            return {
                labels: Object.keys(insurerData),
                datasets: [{ data: Object.values(insurerData), backgroundColor: dashboardControls.chartColors.palette, borderColor: '#fff', borderWidth: 2 }]
            };
        },
        getPolicyTypeData: (policies) => {
            const activePolicies = policies.filter(p => p.status === 'Active' && p.approval_status === 'Approved');
            const metric = state.typeChartMetric; // 'coverage' or 'premium'
            const dataKey = metric === 'coverage' ? 'coverage_amount' : 'premium';

            const typeData = activePolicies.reduce((acc, p) => {
                const typeName = state.insuranceTypes.find(t => t.id === p.insurance_type_id)?.name || 'Unknown';
                acc[typeName] = (acc[typeName] || 0) + p[dataKey];
                return acc;
            }, {});
            return {
                labels: Object.keys(typeData),
                datasets: [{ data: Object.values(typeData), backgroundColor: dashboardControls.chartColors.palette, borderColor: '#fff', borderWidth: 2 }]
            };
        },
        getClaimsTrendData: (claims) => {
            const monthlyData = {};
            claims.forEach(c => {
                const month = c.claim_date.substring(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { count: 0, amount: 0 };
                monthlyData[month].count++;
                monthlyData[month].amount += c.claimed_amount;
            });
            const sortedMonths = Object.keys(monthlyData).sort();
            return {
                labels: sortedMonths,
                datasets: [
                    { label: '# of Claims', data: sortedMonths.map(m => monthlyData[m].count), backgroundColor: 'rgba(54, 162, 235, 0.6)', yAxisID: 'y' },
                    { label: 'Claim Amount', data: sortedMonths.map(m => monthlyData[m].amount), borderColor: 'rgba(255, 99, 132, 1)', type: 'line', yAxisID: 'y1' }
                ]
            };
        },
        getPolicyByDueMonthData: (policies) => {
            const monthLabels = Array.from({length: 12}, (_, i) => {
                const d = new Date();
                d.setMonth(d.getMonth() + i);
                return d.toISOString().substring(0, 7);
            });
            const dueData = monthLabels.reduce((acc, m) => ({...acc, [m]: 0}), {});
            policies.filter(p => p.status === 'Active').forEach(p => {
                const dueMonth = p.end_date.substring(0, 7);
                if (dueData.hasOwnProperty(dueMonth)) {
                    dueData[dueMonth]++;
                }
            });
            return {
                labels: monthLabels,
                datasets: [{ label: 'Policies Due', data: Object.values(dueData), backgroundColor: '#ffce56' }]
            };
        },
        setupChartToggles() {
            const insurerToggle = document.getElementById('insurerChartToggle');
            const typeToggle = document.getElementById('typeChartToggle');

            const handleToggle = (e, stateKey, toggleElement) => {
                const metric = e.target.dataset.metric;
                if (!metric) return;
                state[stateKey] = metric;
                toggleElement.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.metric === metric);
                    btn.classList.toggle('bg-gray-200', btn.dataset.metric !== metric);
                });
                const { policies, claims } = getFilteredData();
                this.initAllCharts(policies, claims);
            };

            insurerToggle.addEventListener('click', (e) => handleToggle(e, 'insurerChartMetric', insurerToggle));
            typeToggle.addEventListener('click', (e) => handleToggle(e, 'typeChartMetric', typeToggle));

            // Initial state
            insurerToggle.querySelector(`button[data-metric="${state.insurerChartMetric}"]`).classList.add('active');
            typeToggle.querySelector(`button[data-metric="${state.typeChartMetric}"]`).classList.add('active');
        },
        handleChartClick(event) {
            const chart = event.chart;
            const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
            if (!points.length) return;
            
            const point = points[0];
            const label = chart.data.labels[point.index];
            let data, title, headers, rows;

            const activePolicies = state.policies.filter(p => p.status === 'Active' && p.approval_status === 'Approved');

            switch (chart.canvas.id) {
                case 'insurerChart':
                    const insurer = state.insurers.find(i => i.name === label);
                    data = activePolicies.filter(p => p.insurer_id === insurer.insurer_id);
                    title = `Active Policies by ${label}`;
                    headers = ['Policy ID', 'Type', 'Coverage', 'Premium'];
                    rows = data.map(p => [ p.policy_id, state.insuranceTypes.find(t => t.id === p.insurance_type_id).name, p.coverage_amount.toLocaleString(), p.premium.toLocaleString() ]);
                    break;
                case 'typeChart':
                    const typeId = state.insuranceTypes.find(t => t.name === label).id;
                    data = activePolicies.filter(p => p.insurance_type_id === typeId);
                    title = `Active Policies: ${label}`;
                    headers = ['Policy ID', 'Entity', 'Coverage', 'Insurer'];
                    rows = data.map(p => [ p.policy_id, state.legalEntities.find(e => e.entity_id === p.entity_id).entity_name, p.coverage_amount.toLocaleString(), state.insurers.find(i => i.insurer_id === p.insurer_id).name ]);
                    break;
                case 'claimsTrendChart':
                    data = state.claims.filter(c => c.claim_date.startsWith(label));
                    title = `Claims in ${label}`;
                    headers = ['Claim ID', 'Policy ID', 'Claim Amount', 'Status'];
                    rows = data.map(c => [c.claim_id, c.policy_id, c.claimed_amount.toLocaleString(), c.status]);
                    break;
                case 'policyByDueMonthChart':
                    data = state.policies.filter(p => p.status === 'Active' && p.end_date.startsWith(label));
                    title = i18n[currentLanguage]['modal_due_policies_title'] + ' ' + label;
                    headers = ['Policy ID', 'Entity', 'Due Date'];
                    rows = data.map(p => [ p.policy_id, state.legalEntities.find(e => e.entity_id === p.entity_id).entity_name, p.end_date ]);
                    break;
                default: return;
            }

            this.showChartDetailModal(title, headers, rows);
        },
        showChartDetailModal(title, headers, rows) {
            const modalTitle = document.getElementById('chartDetailModalTitle');
            const modalBody = document.getElementById('chartDetailModalBody');
            modalTitle.textContent = title;
            if (rows.length > 0) {
                modalBody.innerHTML = `
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr>${headers.map(h => `<th class="px-4 py-2 text-left">${h}</th>`).join('')}</tr></thead>
                            <tbody>${rows.map(row => `<tr class="border-b">${row.map(cell => `<td class="px-4 py-2">${cell}</td>`).join('')}</tr>`).join('')}</tbody>
                        </table>
                    </div>`;
            } else {
                modalBody.innerHTML = '<p>No data to display.</p>';
            }
            showModal(document.getElementById('chartDetailModal'));
        }
    };

    // --- Policy & Claim Shared Controls ---
    const tableControls = {
        showCustomizeColumnsModal(configKey, renderCallback) {
            const modal = document.getElementById('customizeColumnsModal');
            const columnCheckboxes = document.getElementById('columnCheckboxes');
            const sortableColumns = document.getElementById('sortableColumns');
            
            const config = state[configKey];

            const updateSortableList = () => {
                sortableColumns.innerHTML = config.filter(c => c.visible).map(c => 
                    `<li data-key="${c.key}" class="p-2 bg-white border rounded cursor-grab flex justify-between items-center">
                        <span data-i18n-key="${c.labelKey}"></span><i class="fas fa-bars text-gray-400"></i>
                    </li>`
                ).join('');
                translateUI();
            };

            columnCheckboxes.innerHTML = config.map(c => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" data-key="${c.key}" ${c.visible ? 'checked' : ''} class="rounded text-blue-600 focus:ring-blue-500">
                    <span data-i18n-key="${c.labelKey}"></span>
                </label>
            `).join('');
            updateSortableList();
            
            new Sortable(sortableColumns, {
                animation: 150,
                onEnd: (evt) => {
                    const visibleCols = config.filter(c => c.visible);
                    const movedItem = visibleCols.splice(evt.oldIndex, 1)[0];
                    visibleCols.splice(evt.newIndex, 0, movedItem);
                    const invisibleCols = config.filter(c => !c.visible);
                    state[configKey] = [...visibleCols, ...invisibleCols];
                    updateSortableList();
                }
            });

            columnCheckboxes.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const key = e.target.dataset.key;
                    const col = config.find(c => c.key === key);
                    if(col) col.visible = e.target.checked;
                    updateSortableList();
                });
            });

            const saveBtn = document.getElementById('saveCustomColumnsBtn');
            const newSaveBtn = saveBtn.cloneNode(true); // To remove old listeners
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            newSaveBtn.addEventListener('click', () => {
                const dataKey = configKey.includes('policy') ? 'policies' : 'claims';
                renderCallback(getFilteredData()[dataKey]);
                hideModal(modal);
            });

            showModal(modal);
            translateUI();
        },
        applyTableSort(data, sortConfig) {
            if (!sortConfig.key) return data;
            return [...data].sort((a, b) => {
                let valA = a[sortConfig.key];
                let valB = b[sortConfig.key];
                if (typeof valA === 'string') {
                    return sortConfig.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return sortConfig.direction === 'asc' ? (valA || 0) - (valB || 0) : (valB || 0) - (valA || 0);
            });
        },
    };

    // --- Policy Management Controls ---
    const policyControls = {
        init() {
            document.getElementById('addPolicyBtn').addEventListener('click', () => this.showAddEditModal());
            document.getElementById('policySearchInput').addEventListener('input', () => this.renderTable(getFilteredData().policies));
            document.getElementById('policyForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
            document.getElementById('policyCustomizeColumnsBtn').addEventListener('click', () => tableControls.showCustomizeColumnsModal('policyTableColumns', (d) => this.renderTable(d)));
            ['policyFilterEntity', 'policyFilterType', 'policyFilterStatus', 'policyFilterInsurer'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', () => this.renderTable(getFilteredData().policies));
            });
            translateUI();
        },
        applyFilters(policies) {
            const searchTerm = document.getElementById('policySearchInput').value.toLowerCase();
            const filterEntity = document.getElementById('policyFilterEntity').value;
            const filterType = document.getElementById('policyFilterType').value;
            const filterStatus = document.getElementById('policyFilterStatus').value;
            const filterInsurer = document.getElementById('policyFilterInsurer').value;

            return policies.filter(p => {
                const insurer = state.insurers.find(i => i.insurer_id === p.insurer_id);
                const primaryInsurerName = insurer ? insurer.name : '';
                const matchesSearch = p.policy_id.toLowerCase().includes(searchTerm) || primaryInsurerName.toLowerCase().includes(searchTerm);
                const matchesEntity = !filterEntity || p.entity_id === filterEntity;
                const matchesType = !filterType || p.insurance_type_id == filterType;
                
                let matchesStatus = !filterStatus;
                if (filterStatus) {
                    if (filterStatus === 'Approved') matchesStatus = p.approval_status === 'Approved';
                    else {
                        const currentStatus = p.approval_status !== 'Approved' ? p.approval_status : p.status;
                        matchesStatus = currentStatus === filterStatus;
                    }
                }
                
                const matchesInsurer = !filterInsurer || p.insurer_id === filterInsurer || (p.is_coinsurance && p.coinsurers.some(ci => ci.insurer_id === filterInsurer));
                return matchesSearch && matchesEntity && matchesType && matchesStatus && matchesInsurer;
            });
        },
        renderTable(policies) {
            const tableHead = document.getElementById('policyTableHead');
            const tableBody = document.getElementById('policyTableBody');
            if (!tableHead || !tableBody) return;
            
            const visibleColumns = state.policyTableColumns.filter(c => c.visible);
            tableHead.innerHTML = `<tr>${visibleColumns.map(c => 
                `<th scope="col" class="px-6 py-3 cursor-pointer" data-key="${c.key}">
                    <span data-i18n-key="${c.labelKey}"></span>
                    ${state.policySort.key === c.key ? (state.policySort.direction === 'asc' ? '▲' : '▼') : ''}
                </th>`
            ).join('')}<th scope="col" class="px-6 py-3"><span data-i18n-key="col_actions"></span></th></tr>`;

            const filteredPolicies = this.applyFilters(policies);
            const sortedPolicies = tableControls.applyTableSort(filteredPolicies, state.policySort);

            tableBody.innerHTML = sortedPolicies.map(p => {
                const isEditable = p.approval_status !== 'Approved';
                return `<tr class="bg-white border-b hover:bg-gray-50">
                    ${visibleColumns.map(c => {
                        const val = c.formatter ? c.formatter(p[c.key], p) : p[c.key];
                        const content = c.key === 'policy_id' ? `<a href="#" data-id="${p.policy_id}" class="view-policy-details-btn text-blue-600 hover:text-blue-800 font-bold">${val}</a>` : val;
                        return `<td class="px-6 py-4">${content || 'N/A'}</td>`;
                    }).join('')}
                    <td class="px-6 py-4">
                        <button data-id="${p.policy_id}" class="edit-policy-btn text-yellow-600 hover:text-yellow-800 mr-2" title="Edit" ${!isEditable ? 'disabled' : ''}><i class="fas fa-edit ${!isEditable ? 'text-gray-400' : ''}"></i></button>
                    </td>
                </tr>`;
            }).join('');
            
            translateUI();

            tableHead.querySelectorAll('th[data-key]').forEach(th => th.addEventListener('click', (e) => {
                const key = e.currentTarget.dataset.key;
                if (state.policySort.key === key) {
                    state.policySort.direction = state.policySort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    state.policySort.key = key;
                    state.policySort.direction = 'asc';
                }
                this.renderTable(policies);
            }));
            
            tableBody.querySelectorAll('.edit-policy-btn').forEach(btn => btn.addEventListener('click', (e) => this.showAddEditModal(state.policies.find(p => p.policy_id === e.currentTarget.dataset.id))));
            tableBody.querySelectorAll('.view-policy-details-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.preventDefault();
                this.showPolicyDetailsModal(state.policies.find(p => p.policy_id === e.currentTarget.dataset.id));
            }));
        },
        showPolicyDetailsModal(policy) {
            if (!policy) return;
            const detailBody = document.getElementById('policyDetailBody');
            if (!detailBody) return;
            
            const entity = state.legalEntities.find(e => e.entity_id === policy.entity_id);
            const type = state.insuranceTypes.find(t => t.id === policy.insurance_type_id);
            const insurer = state.insurers.find(i => i.insurer_id === policy.insurer_id);
            const claims = state.claims.filter(c => c.policy_id === policy.policy_id);

            let specificDetailsHtml = this.getSpecificDetailsHtml(policy, 'view');
            let coinsuranceHtml = '';
            if (policy.is_coinsurance && policy.coinsurers && policy.coinsurers.length > 0) {
                coinsuranceHtml = `
                    <div class="bg-white p-4 rounded-lg border md:col-span-2 mt-4">
                        <h4 class="font-bold mb-2" data-i18n-key="label_coinsurance_details"></h4>
                        <table class="details-table">
                            <thead><tr><th data-i18n-key="form_coinsurer"></th><th data-i18n-key="form_coinsurance_ratio"></th></tr></thead>
                            <tbody>${policy.coinsurers.map(ci => {
                                const coInsurer = state.insurers.find(i => i.insurer_id === ci.insurer_id);
                                return `<tr><td>${coInsurer?.name || 'N/A'}</td><td>${ci.ratio}%</td></tr>`
                            }).join('')}</tbody>
                        </table>
                    </div>`;
            }

            detailBody.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg border">
                        <h4 class="font-bold mb-2" data-i18n-key="modal_policy_detail_title"></h4>
                        <p><strong>${i18n[currentLanguage]['form_policy_id']}:</strong> ${policy.policy_id}</p>
                        <p><strong>${i18n[currentLanguage]['form_insurance_type']}:</strong> ${type?.name || 'N/A'}</p>
                        <p><strong>${i18n[currentLanguage]['form_entity']}:</strong> ${entity?.entity_name || 'N/A'}</p>
                        <p><strong>${i18n[currentLanguage]['form_insurer']}:</strong> ${insurer?.name || 'N/A'}</p>
                        <p><strong>${i18n[currentLanguage]['form_coverage_amount']}:</strong> ${policy.coverage_amount.toLocaleString()} ${policy.currency_code}</p>
                        <p><strong>${i18n[currentLanguage]['form_premium']}:</strong> ${policy.premium.toLocaleString()} ${policy.currency_code}</p>
                        <p><strong>${i18n[currentLanguage]['form_deductible']}:</strong> ${policy.deductible.toLocaleString()} ${policy.currency_code}</p>
                        <p><strong>${i18n[currentLanguage]['form_start_date']}:</strong> ${policy.start_date}</p>
                        <p><strong>${i18n[currentLanguage]['form_end_date']}:</strong> ${policy.end_date}</p>
                        <p><strong>${i18n[currentLanguage]['form_status']}:</strong> ${getStatusBadge(policy.approval_status !== 'Approved' ? policy.approval_status : policy.status)}</p>
                        ${policy.attached_file ? `<p><strong>${i18n[currentLanguage]['form_attached_file']}:</strong> <a href="#" data-file="${policy.attached_file}" class="view-pdf-btn text-blue-600 hover:underline">${policy.attached_file}</a></p>` : ''}
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <h4 class="font-bold mb-2">Claim History</h4>
                        ${claims.length > 0 ? `<table class="details-table"><thead><tr><th>ID</th><th>Amount</th><th>Status</th></tr></thead><tbody>${claims.map(c => `<tr><td>${c.claim_id}</td><td>${c.claimed_amount.toLocaleString()} ${c.currency_code}</td><td>${getStatusBadge(c.status)}</td></tr>`).join('')}</tbody></table>` : '<p>No claims recorded.</p>'}
                    </div>
                    ${specificDetailsHtml ? `<div class="bg-white p-4 rounded-lg border md:col-span-2 mt-4"><h4 class="font-bold mb-2">Specific Details</h4>${specificDetailsHtml}</div>` : ''}
                </div>
                ${coinsuranceHtml}
            `;
            showModal(document.getElementById('policyDetailModal'));
            translateUI();

            detailBody.querySelectorAll('.view-pdf-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPdfViewer(`https://placehold.co/800x600/FF0000/FFFFFF?text=Mock+PDF+Preview`);
                });
            });
        },
        getSpecificDetailsHtml(policy, mode = 'edit') {
            const typeId = parseInt(policy?.insurance_type_id || 0);
            let html = '';
            const fields = {
                1: [{ key: 'insured_object', type: 'text' }],
                2: [{ key: 'is_rider_to_fire', type: 'checkbox' }, { key: 'earthquake_coverage', type: 'number' }, { key: 'payment_terms', type: 'text' }],
                3: [{ key: 'equipment_id', type: 'text' }, { key: 'maintenance_record_req', type: 'checkbox' }, { key: 'installation_site', type: 'text' }],
                4: [{ key: 'waiting_period', type: 'text' }, { key: 'compensation_basis', type: 'text' }, { key: 'daily_total_limit', type: 'text' }],
                5: [{ key: 'transport_mode', type: 'text' }, { key: 'from_to_location', type: 'text' }, { key: 'declaration_type', type: 'text' }, { key: 'packing_terms', type: 'text' }, { key: 'loading_unloading_terms', type: 'text' }],
                6: [{ key: 'general_liability_scope', type: 'textarea' }, { key: 'per_occurrence_limit', type: 'number' }, { key: 'aggregate_limit', type: 'number' }, { key: 'territorial_limit', type: 'text' }],
                7: [{ key: 'product_liability_scope', type: 'textarea' }, { key: 'territorial_coverage', type: 'text' }, { key: 'retroactive_period', type: 'text' }, { key: 'legal_defense_included', type: 'checkbox' }],
                8: [{ key: 'employee_scope', type: 'text' }, { key: 'coverage_limits', type: 'text' }, { key: 'overlap_labor_insurance', type: 'checkbox' }],
            };

            if (fields[typeId]) {
                fields[typeId].forEach(field => {
                    const value = policy?.[field.key] ?? '';
                    if (mode === 'view') {
                        html += `<p class="mt-2"><strong>${i18n[currentLanguage]['form_' + field.key] || field.key}:</strong> ${value === true ? 'Yes' : (value === false ? 'No' : value || 'N/A')}</p>`;
                    } else {
                        const label = `<label for="${field.key}" class="block text-sm font-medium text-gray-700" data-i18n-key="form_${field.key}"></label>`;
                        let input = '';
                        if (field.type === 'checkbox') {
                            input = `<input type="checkbox" id="${field.key}" name="${field.key}" class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded" ${value ? 'checked' : ''}>`;
                        } else if (field.type === 'textarea') {
                            input = `<textarea id="${field.key}" name="${field.key}" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm">${value}</textarea>`;
                        } else {
                            input = `<input type="${field.type}" id="${field.key}" name="${field.key}" value="${value}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm">`;
                        }
                        html += `<div class="${field.type === 'textarea' ? 'md:col-span-2' : ''}">${label}${input}</div>`;
                    }
                });
            }
            return html;
        },
        showAddEditModal(policy = null) {
            const formBody = document.getElementById('policyFormBody');
            if (!formBody) return;
            const isEditMode = policy !== null;
            document.getElementById('policyModalTitle').dataset.i18nKey = isEditMode ? 'modal_edit_policy_title' : 'modal_add_policy_title';
            
            const createField = (labelKey, id, type = 'text', options = [], required = true, value = '', readonly = false) => {
                const inputHtml = type === 'select' ? `<select id="${id}" name="${id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" ${required ? 'required' : ''}>${options.map(o => `<option value="${o.value}" ${o.value == value ? 'selected' : ''}>${o.text}</option>`).join('')}</select>` : `<input type="${type}" id="${id}" name="${id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm ${readonly ? 'bg-gray-100' : ''}" ${required ? 'required' : ''} value="${value}" ${readonly ? 'readonly' : ''}>`;
                return `<div><label for="${id}" class="block text-sm font-medium text-gray-700" data-i18n-key="${labelKey}"></label>${inputHtml}</div>`;
            };
            
            const typeOptions = state.insuranceTypes.map(t => {
                const i18nKey = `type_${t.name.toLowerCase().replace(/[\s/]+/g, '_').replace(/_+$/, '')}`;
                return { value: t.id, text: i18n[currentLanguage][i18nKey] || t.name };
            });

            formBody.innerHTML = `
                <input type="hidden" id="policy_id_hidden" value="${policy?.policy_id || ''}">
                ${createField('form_policy_id', 'policy_id', 'text', [], true, policy?.policy_id || `POL-${Date.now()}`, isEditMode)}
                ${createField('form_insurance_type', 'insurance_type_id', 'select', typeOptions, true, policy?.insurance_type_id || 1)}
                ${createField('form_entity', 'entity_id', 'select', state.legalEntities.map(e => ({ value: e.entity_id, text: e.entity_name })), true, policy?.entity_id || '')}
                ${createField('form_insurer', 'insurer_id', 'select', state.insurers.map(i => ({ value: i.insurer_id, text: i.name })), true, policy?.insurer_id || '')}
                ${createField('form_coverage_amount', 'coverage_amount', 'number', [], true, policy?.coverage_amount || '')}
                ${createField('form_premium', 'premium', 'number', [], true, policy?.premium || '')}
                ${createField('form_deductible', 'deductible', 'number', [], true, policy?.deductible || '')}
                ${createField('form_currency', 'currency_code', 'select', [{value:'USD',text:'USD'},{value:'EUR',text:'EUR'},{value:'JPY',text:'JPY'},{value:'CNY',text:'CNY'},{value:'TWD',text:'TWD'}], true, policy?.currency_code || 'USD')}
                ${createField('form_start_date', 'start_date', 'date', [], true, policy?.start_date || '')}
                ${createField('form_end_date', 'end_date', 'date', [], true, policy?.end_date || '')}
                <div>
                    <label for="is_coinsurance" class="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                        <input type="checkbox" id="is_coinsurance" name="is_coinsurance" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded" ${policy?.is_coinsurance ? 'checked' : ''}>
                        <span data-i18n-key="form_is_coinsurance"></span>
                    </label>
                </div>
                <div id="specific-fields-container" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 border-t pt-4 mt-4"></div>
                <div id="coinsurance_details_container" class="md:col-span-2 ${policy?.is_coinsurance ? '' : 'hidden'}">
                    <h4 class="font-semibold mb-2" data-i18n-key="label_coinsurance_details"></h4>
                    <div id="coinsurance_entries" class="space-y-3"></div>
                    <button type="button" id="add_coinsurer_btn" class="mt-3 bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 text-sm" data-i18n-key="btn_add_coinsurer"></button>
                </div>
            `;
            
            const specificFieldsContainer = formBody.querySelector('#specific-fields-container');
            const insuranceTypeSelect = formBody.querySelector('#insurance_type_id');
            const coinsuranceCheckbox = formBody.querySelector('#is_coinsurance');
            const coinsuranceContainer = formBody.querySelector('#coinsurance_details_container');
            const addCoinsurerBtn = formBody.querySelector('#add_coinsurer_btn');
            const coinsuranceEntries = formBody.querySelector('#coinsurance_entries');

            const renderSpecificFields = () => {
                const selectedTypeId = parseInt(insuranceTypeSelect.value);
                const policyForFields = { ...policy, insurance_type_id: selectedTypeId };
                specificFieldsContainer.innerHTML = this.getSpecificDetailsHtml(policyForFields, 'edit');
                translateUI();
            };

            const addCoinsurerEntry = (coinsurer = { insurer_id: '', ratio: '' }) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'flex items-center space-x-2';
                
                const leadInsurerId = document.getElementById('insurer_id').value;
                const existingCoinsurerIds = Array.from(coinsuranceEntries.querySelectorAll('[name="coinsurer_id"]')).map(select => select.value).filter(id => id && id !== coinsurer.insurer_id);

                const availableInsurers = state.insurers.filter(i => i.insurer_id !== leadInsurerId && !existingCoinsurerIds.includes(i.insurer_id));

                entryDiv.innerHTML = `
                    <select name="coinsurer_id" class="block w-1/2 border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                        <option value="">-- Select Co-insurer --</option>
                        ${availableInsurers.map(i => `<option value="${i.insurer_id}" ${coinsurer.insurer_id === i.insurer_id ? 'selected' : ''}>${i.name}</option>`).join('')}
                    </select>
                    <input type="number" name="coinsurer_ratio" placeholder="Ratio (%)" value="${coinsurer.ratio}" class="block w-1/3 border-gray-300 rounded-md shadow-sm sm:text-sm" required min="1" max="100">
                    <button type="button" class="remove-coinsurer-btn text-red-500 hover:text-red-700">&times;</button>
                `;
                coinsuranceEntries.appendChild(entryDiv);
                entryDiv.querySelector('.remove-coinsurer-btn').addEventListener('click', () => entryDiv.remove());
            };

            insuranceTypeSelect.addEventListener('change', renderSpecificFields);
            coinsuranceCheckbox.addEventListener('change', () => coinsuranceContainer.classList.toggle('hidden', !coinsuranceCheckbox.checked));
            addCoinsurerBtn.addEventListener('click', () => addCoinsurerEntry());

            if (isEditMode && policy.is_coinsurance && policy.coinsurers) {
                policy.coinsurers.forEach(addCoinsurerEntry);
            }

            renderSpecificFields();
            showModal(document.getElementById('addEditPolicyModal'));
            translateUI();
        },
        handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const policyId = form.policy_id.value;
            const isEditMode = !!form.policy_id_hidden.value;
            const originalPolicy = isEditMode ? state.policies.find(p => p.policy_id === policyId) : {};

            const policyData = {
                ...originalPolicy,
                policy_id: policyId,
                insurance_type_id: parseInt(form.insurance_type_id.value) || 0,
                entity_id: form.entity_id.value,
                insurer_id: form.insurer_id.value,
                coverage_amount: parseFloat(form.coverage_amount.value) || 0,
                premium: parseFloat(form.premium.value) || 0,
                deductible: parseFloat(form.deductible.value) || 0,
                currency_code: form.currency_code.value,
                start_date: form.start_date.value,
                end_date: form.end_date.value,
                approval_status: 'Pending Approval',
                created_by: isEditMode ? originalPolicy.created_by : currentUser.user_id,
                created_date: isEditMode ? originalPolicy.created_date : new Date().toISOString().split('T')[0],
                approved_by: null,
                is_coinsurance: form.is_coinsurance.checked,
                coinsurers: []
            };

            const specificFieldsContainer = form.querySelector('#specific-fields-container');
            specificFieldsContainer.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.name) {
                    policyData[input.name] = input.type === 'checkbox' ? input.checked : (input.type === 'number' ? parseFloat(input.value) || 0 : input.value);
                }
            });

            if (policyData.is_coinsurance) {
                const entries = form.querySelectorAll('#coinsurance_entries > div');
                let totalRatio = 0;
                entries.forEach(entry => {
                    const insurerId = entry.querySelector('[name="coinsurer_id"]').value;
                    const ratio = parseFloat(entry.querySelector('[name="coinsurer_ratio"]').value) || 0;
                    if (insurerId && ratio > 0) {
                        policyData.coinsurers.push({ insurer_id: insurerId, ratio: ratio });
                        totalRatio += ratio;
                    }
                });
                
                if (totalRatio >= 100) {
                     showCustomConfirm(i18n[currentLanguage]['alert_coinsurance_ratio_sum_error'], () => {}, 'Error');
                     return;
                }
            }

            if (isEditMode) {
                const index = state.policies.findIndex(p => p.policy_id === policyId);
                if (index > -1) {
                    state.policies[index] = policyData;
                    logAction('Edited Policy', `Policy ID: ${policyId}`);
                }
            } else {
                state.policies.push(policyData);
                logAction('Created Policy', `Policy ID: ${policyId}`);
            }
            hideModal(document.getElementById('addEditPolicyModal'));
            renderAllActiveViews();
        },
    };

    // --- Claims Management Controls ---
    const claimsControls = {
        init() {
            document.getElementById('addClaimBtn').addEventListener('click', () => this.showAddClaimModal());
            document.getElementById('claimSearchInput').addEventListener('input', () => this.renderTable(getFilteredData().claims));
            document.getElementById('claimForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
            document.getElementById('claimCustomizeColumnsBtn').addEventListener('click', () => tableControls.showCustomizeColumnsModal('claimsTableColumns', (d) => this.renderTable(d)));
        },
        renderTable(claims) {
            const tableHead = document.getElementById('claimsTableHead');
            const tableBody = document.getElementById('claimsTableBody');
            if (!tableHead || !tableBody) return;

            const visibleColumns = state.claimsTableColumns.filter(c => c.visible);
            tableHead.innerHTML = `<tr>${visibleColumns.map(c => 
                `<th scope="col" class="px-6 py-3 cursor-pointer" data-key="${c.key}">
                    <span data-i18n-key="${c.labelKey}"></span>
                    ${state.claimSort.key === c.key ? (state.claimSort.direction === 'asc' ? '▲' : '▼') : ''}
                </th>`
            ).join('')}<th scope="col" class="px-6 py-3"><span data-i18n-key="col_actions"></span></th></tr>`;

            const searchTerm = document.getElementById('claimSearchInput').value.toLowerCase();
            const filteredClaims = claims.filter(c => c.claim_id.toLowerCase().includes(searchTerm) || c.policy_id.toLowerCase().includes(searchTerm));
            const sortedClaims = tableControls.applyTableSort(filteredClaims, state.claimSort);
            
            tableBody.innerHTML = sortedClaims.map(c => {
                const isEditable = c.approval_status !== 'Approved';
                return `<tr class="bg-white border-b hover:bg-gray-50">
                    ${visibleColumns.map(col => {
                        const val = col.formatter ? col.formatter(c[col.key], c) : c[col.key];
                        const content = col.key === 'claim_id' ? `<a href="#" data-id="${c.claim_id}" class="view-claim-details-btn text-blue-600 hover:text-blue-800 font-bold">${val}</a>` : val;
                        return `<td class="px-6 py-4">${content || 'N/A'}</td>`;
                    }).join('')}
                    <td class="px-6 py-4">
                        <button data-id="${c.claim_id}" class="edit-claim-btn text-yellow-600 hover:text-yellow-800" title="Edit" ${!isEditable ? 'disabled' : ''}><i class="fas fa-edit ${!isEditable ? 'text-gray-400' : ''}"></i></button>
                    </td>
                </tr>`
            }).join('');

            translateUI();
            
            tableHead.querySelectorAll('th[data-key]').forEach(th => th.addEventListener('click', (e) => {
                const key = e.currentTarget.dataset.key;
                if (state.claimSort.key === key) {
                    state.claimSort.direction = state.claimSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    state.claimSort.key = key;
                    state.claimSort.direction = 'asc';
                }
                this.renderTable(claims);
            }));

            tableBody.querySelectorAll('.edit-claim-btn').forEach(btn => btn.addEventListener('click', (e) => this.showAddClaimModal(state.claims.find(c => c.claim_id === e.currentTarget.dataset.id))));
            tableBody.querySelectorAll('.view-claim-details-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.preventDefault();
                this.showClaimDetailsModal(state.claims.find(c => c.claim_id === e.currentTarget.dataset.id));
            }));
        },
        showClaimDetailsModal(claim) {
            if (!claim) return;
            const detailBody = document.getElementById('claimDetailBody');
            if (!detailBody) return;

            const policy = state.policies.find(p => p.policy_id === claim.policy_id);
            const insurer = policy ? state.insurers.find(i => i.insurer_id === policy.insurer_id) : null;
            
            detailBody.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg border">
                        <h4 class="font-bold mb-2" data-i18n-key="modal_claim_detail_title"></h4>
                        <p><strong>${i18n[currentLanguage]['table_claim_id']}:</strong> ${claim.claim_id}</p>
                        <p><strong>${i18n[currentLanguage]['table_policy_id']}:</strong> ${claim.policy_id}</p>
                        <p><strong>${i18n[currentLanguage]['form_insurer']}:</strong> ${insurer?.name || 'N/A'}</p>
                        <p><strong>${i18n[currentLanguage]['table_claim_date']}:</strong> ${claim.claim_date}</p>
                        <p><strong>${i18n[currentLanguage]['table_claimed_amount']}:</strong> ${claim.claimed_amount.toLocaleString()} ${claim.currency_code}</p>
                        <p><strong>${i18n[currentLanguage]['table_status']}:</strong> ${getStatusBadge(claim.approval_status !== 'Approved' ? claim.approval_status : claim.status)}</p>
                        <p><strong>${i18n[currentLanguage]['table_payment_status']}:</strong> ${getStatusBadge(claim.payment_status)}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <h4 class="font-bold mb-2">Incident Details</h4>
                        <p><strong>${i18n[currentLanguage]['form_location_of_loss']}:</strong> ${claim.location_of_loss}</p>
                        <p><strong>${i18n[currentLanguage]['form_reporting_manager']}:</strong> ${claim.reporting_manager}</p>
                        <p><strong>${i18n[currentLanguage]['form_incident_description']}:</strong></p>
                        <p class="mt-1 p-2 bg-gray-50 rounded">${claim.incident_description}</p>
                        ${claim.photo_evidence ? `<p class="mt-2"><strong>${i18n[currentLanguage]['form_photo_evidence']}:</strong> <a href="#" data-file="${claim.photo_evidence}" class="view-pdf-btn text-blue-600 hover:underline">${claim.photo_evidence}</a></p>` : ''}
                    </div>
                </div>
            `;
            showModal(document.getElementById('claimDetailModal'));
            translateUI();

            detailBody.querySelectorAll('.view-pdf-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPdfViewer(`https://placehold.co/600x400/cccccc/333333?text=Mock+Photo+Preview`);
                });
            });
        },
        showAddClaimModal(claim = null) {
            const { policies } = getFilteredData();
            const formBody = document.getElementById('claimFormBody');
            if (!formBody) return;
            const isEditMode = claim !== null;
            document.getElementById('claimModalTitle').dataset.i18nKey = isEditMode ? 'modal_edit_claim_title' : 'modal_add_claim_title';

            const policyOptions = policies
                .filter(p => p.approval_status === 'Approved' && p.status === 'Active')
                .map(p => {
                    const type = state.insuranceTypes.find(t => t.id === p.insurance_type_id);
                    const typeName = type ? type.name : 'Unknown Type';
                    const selected = claim?.policy_id === p.policy_id ? 'selected' : '';
                    return `<option value="${p.policy_id}" ${selected}>${p.policy_id} (${typeName})</option>`;
                }).join('');

            formBody.innerHTML = `
                <input type="hidden" id="claim_id_hidden" value="${claim?.claim_id || ''}">
                <div>
                    <label for="claim_policy_id" class="block text-sm font-medium text-gray-700" data-i18n-key="form_policy_id"></label>
                    <select id="claim_policy_id" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                        <option value="">-- Select Policy --</option>
                        ${policyOptions}
                    </select>
                </div>
                <div>
                    <label for="claim_date" class="block text-sm font-medium text-gray-700" data-i18n-key="form_claim_date"></label>
                    <input type="date" id="claim_date" value="${claim?.claim_date || new Date().toISOString().split('T')[0]}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                </div>
                <div>
                    <label for="claim_amount" class="block text-sm font-medium text-gray-700" data-i18n-key="form_claimed_amount"></label>
                    <input type="number" id="claim_amount" value="${claim?.claimed_amount || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                </div>
                 <div>
                    <label for="claim_currency" class="block text-sm font-medium text-gray-700" data-i18n-key="form_currency"></label>
                    <select id="claim_currency" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-gray-100" required disabled>
                        ${['USD', 'EUR', 'JPY', 'CNY', 'TWD'].map(c => `<option value="${c}" ${claim?.currency_code === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="location_of_loss" class="block text-sm font-medium text-gray-700" data-i18n-key="form_location_of_loss"></label>
                    <input type="text" id="location_of_loss" value="${claim?.location_of_loss || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                </div>
                <div class="md:col-span-2">
                    <label for="incident_description" class="block text-sm font-medium text-gray-700" data-i18n-key="form_incident_description"></label>
                    <textarea id="incident_description" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>${claim?.incident_description || ''}</textarea>
                </div>
                <div>
                    <label for="reporting_manager" class="block text-sm font-medium text-gray-700" data-i18n-key="form_reporting_manager"></label>
                    <input type="text" id="reporting_manager" value="${claim?.reporting_manager || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                </div>
                <div>
                    <label for="payment_status" class="block text-sm font-medium text-gray-700" data-i18n-key="form_payment_status"></label>
                    <select id="payment_status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                        ${['Pending', 'Paid', 'Not Applicable'].map(s => `<option value="${s}" ${claim?.payment_status === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </div>
                 <div class="md:col-span-2">
                    <label for="photo_evidence" class="block text-sm font-medium text-gray-700" data-i18n-key="form_photo_evidence"></label>
                    <input type="file" id="photo_evidence" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
            `;
            
            const policySelect = formBody.querySelector('#claim_policy_id');
            const currencySelect = formBody.querySelector('#claim_currency');
            const updateCurrency = () => {
                const selectedPolicy = state.policies.find(p => p.policy_id === policySelect.value);
                if (selectedPolicy) {
                    currencySelect.value = selectedPolicy.currency_code;
                    currencySelect.disabled = true;
                } else {
                    currencySelect.disabled = true;
                }
            };
            policySelect.addEventListener('change', updateCurrency);
            updateCurrency();

            showModal(document.getElementById('addClaimModal'));
            translateUI();
        },
        handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const isEditMode = !!form.querySelector('#claim_id_hidden')?.value;
            const claimId = isEditMode ? form.querySelector('#claim_id_hidden').value : `C${new Date().getFullYear()}-${String(state.claims.length + 1).padStart(4, '0')}`;
            const originalClaim = isEditMode ? state.claims.find(c => c.claim_id === claimId) : {};
            
            const claimData = {
                ...originalClaim,
                claim_id: claimId,
                policy_id: form.claim_policy_id.value,
                claim_date: form.claim_date.value,
                claimed_amount: parseFloat(form.claim_amount.value) || 0,
                currency_code: form.claim_currency.value,
                approval_status: 'Pending Approval',
                location_of_loss: form.location_of_loss.value,
                incident_description: form.incident_description.value,
                reporting_manager: form.reporting_manager.value,
                payment_status: form.payment_status.value,
                photo_evidence: form.photo_evidence.files.length > 0 ? form.photo_evidence.files[0].name : originalClaim.photo_evidence,
                created_by: isEditMode ? originalClaim.created_by : currentUser.user_id,
                created_date: isEditMode ? originalClaim.created_date : new Date().toISOString().split('T')[0],
                approved_by: null
            };

            if (isEditMode) {
                const index = state.claims.findIndex(c => c.claim_id === claimId);
                if (index > -1) {
                    state.claims[index] = claimData;
                    logAction('Edited Claim', `Claim ID: ${claimId}`);
                }
            } else {
                state.claims.push(claimData);
                logAction('Created Claim', `Claim ID: ${claimId} for Policy ${claimData.policy_id}`);
            }
            hideModal(document.getElementById('addClaimModal'));
            renderAllActiveViews();
        },
    };

    // --- Insurer Management Controls ---
    const insurerControls = {
        init() {
            document.getElementById('addInsurerBtn').addEventListener('click', () => this.showAddEditModal());
            document.getElementById('insurerSearchInput').addEventListener('input', () => this.renderTable(state.insurers));
            document.getElementById('insurerForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
        },
        renderTable(insurersData) {
            const tableBody = document.getElementById('insurerTableBody');
            if (!tableBody) return;
            const searchTerm = document.getElementById('insurerSearchInput').value.toLowerCase();
            const filtered = insurersData.filter(i => i.name.toLowerCase().includes(searchTerm));
            tableBody.innerHTML = filtered.map(i => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${i.insurer_id}</td>
                    <td class="px-6 py-4 font-medium">${i.name}</td>
                    <td class="px-6 py-4">${i.region}</td>
                    <td class="px-6 py-4">
                        <button data-id="${i.insurer_id}" class="edit-insurer-btn text-yellow-600 hover:text-yellow-800 mr-2" title="Edit"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>`).join('');
            tableBody.querySelectorAll('.edit-insurer-btn').forEach(btn => btn.addEventListener('click', (e) => this.showAddEditModal(state.insurers.find(i => i.insurer_id === e.currentTarget.dataset.id))));
        },
        showAddEditModal(insurer = null) {
            const isEditMode = insurer !== null;
            document.getElementById('insurerModalTitle').dataset.i18nKey = isEditMode ? 'modal_edit_insurer_title' : 'modal_add_insurer_title';
            document.getElementById('insurer_id_input').value = insurer?.insurer_id || '';
            document.getElementById('insurer_id_input').readOnly = isEditMode;
            document.getElementById('insurer_name_input').value = insurer?.name || '';
            document.getElementById('insurer_region_input').value = insurer?.region || '';
            showModal(document.getElementById('addEditInsurerModal'));
            translateUI();
        },
        handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const isEditMode = form.insurer_id_input.readOnly;
            const insurerId = form.insurer_id_input.value;
            const newInsurer = { insurer_id: insurerId, name: form.insurer_name_input.value, region: form.insurer_region_input.value };
            if (isEditMode) {
                const index = state.insurers.findIndex(i => i.insurer_id === insurerId);
                if (index > -1) state.insurers[index] = newInsurer;
                logAction('Edited Insurer', `Insurer: ${newInsurer.name}`);
            } else {
                state.insurers.push(newInsurer);
                logAction('Created Insurer', `Insurer: ${newInsurer.name}`);
            }
            hideModal(document.getElementById('addEditInsurerModal'));
            renderAllActiveViews();
        },
    };

    // --- User Management Controls ---
    const userControls = {
        init() {
            document.getElementById('userSearchInput').addEventListener('input', () => this.renderTable(state.users));
            document.getElementById('userForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
        },
        renderTable(usersData) {
            const tableBody = document.getElementById('userTableBody');
            if (!tableBody) return;
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const filtered = usersData.filter(u => u.username.toLowerCase().includes(searchTerm));
            tableBody.innerHTML = filtered.map(u => {
                const role = state.roles.find(r => r.role_id === u.role_id);
                return `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4">${u.user_id}</td>
                        <td class="px-6 py-4 font-medium">${u.username}</td>
                        <td class="px-6 py-4">${role?.role_name || 'N/A'}</td>
                        <td class="px-6 py-4">${u.assigned_region}</td>
                        <td class="px-6 py-4"><button data-id="${u.user_id}" class="edit-user-btn text-yellow-600 hover:text-yellow-800" title="Edit"><i class="fas fa-edit"></i></button></td>
                    </tr>`;
            }).join('');
            tableBody.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', (e) => this.showEditUserModal(state.users.find(u => u.user_id === e.currentTarget.dataset.id))));
        },
        showEditUserModal(user) {
            if (!user) return;
            document.getElementById('user_id_input').value = user.user_id;
            document.getElementById('username_input').value = user.username;
            document.getElementById('role_input').innerHTML = state.roles.map(r => `<option value="${r.role_id}" ${user.role_id === r.role_id ? 'selected' : ''}>${r.role_name}</option>`).join('');
            document.getElementById('assigned_region_input').value = user.assigned_region;
            showModal(document.getElementById('addEditUserModal'));
            translateUI();
        },
        handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.user_id_input.value;
            const updatedUser = {
                user_id: userId,
                username: form.username_input.value,
                role_id: parseInt(form.role_input.value) || 0,
                assigned_region: form.assigned_region_input.value
            };
            const index = state.users.findIndex(u => u.user_id === userId);
            if (index > -1) state.users[index] = {...state.users[index], ...updatedUser};
            logAction('Edited User', `User: ${updatedUser.username}`);
            hideModal(document.getElementById('addEditUserModal'));
            setupSwitchers();
            renderAllActiveViews();
        },
    };

    // --- Log Management Controls ---
    const logControls = {
        renderTable(logs) {
            const tableBody = document.getElementById('logTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = logs.map(log => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${new Date(log.timestamp).toLocaleString()}</td>
                    <td class="px-6 py-4">${log.user}</td>
                    <td class="px-6 py-4 font-medium">${log.action}</td>
                    <td class="px-6 py-4">${log.details}</td>
                </tr>
            `).join('');
        }
    };

    // --- Modal Utility Functions ---
    const showModal = (modal) => modal.classList.remove('hidden');
    const hideModal = (modal) => modal.classList.add('hidden');
    document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => hideModal(e.target.closest('.modal'))));
    
    let okCallback = null;
    function showCustomConfirm(message, onOK, title = 'Confirm') {
        document.getElementById('customConfirmModalTitle').textContent = title;
        document.getElementById('customConfirmModalMessage').textContent = message;
        okCallback = onOK;
        showModal(document.getElementById('customConfirmModal'));
        translateUI();
    }
    document.getElementById('customConfirmOKBtn').addEventListener('click', () => { if (okCallback) okCallback(); hideModal(document.getElementById('customConfirmModal')); });
    document.getElementById('customConfirmCancelBtn').addEventListener('click', () => hideModal(document.getElementById('customConfirmModal')));

    function showPdfViewer(pdfUrl) {
        document.getElementById('pdfViewerFrame').src = pdfUrl;
        showModal(document.getElementById('pdfViewerModal'));
    }

    // --- App Initialization ---
    const initApp = () => {
        setupSwitchers();
        policyControls.init();
        claimsControls.init();
        insurerControls.init();
        userControls.init();
        updateAppForUser(); 
        logAction('System Initialized');
        const dashboardLink = document.querySelector('.nav-link[data-target="dashboard-view"]');
        if (dashboardLink) dashboardLink.click();
    };

    initApp();
});
</script>

</body>
</html>
